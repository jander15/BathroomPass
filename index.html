<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Pass System by Jander</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
    >
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <meta name="google-signin-client_id" content="683459371071-7bm37ul6uatesp6g5nsf8lu1mnl9pnjm.apps.googleusercontent.com">
    <script type="text/javascript">
    window.onbeforeunload = function() {
        // Thiss will prompt the user before leaving the page.
        // It's generally good practice to inform users if they are about to lose unsaved data.
        return "Hi, are you sure you want to leave? Think of the kittens!";
    }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1d1d; /* A lighter green for the page background */
        }
        form {
            font-size: 1.125rem; /* text-lg */
            transition: background-color 0.5s ease; /* Smooth transition for form color changes */
        }
        select {
            font-size: 1.125rem; /* text-lg for consistency with form text */
        }
        /* Removed focus:ring styles from select elements */
        select:focus {
            outline: none;
            border-color: #d1d5db; /* Revert to default border color on focus */
            box-shadow: none; /* Remove any box shadow on focus */
        }
        #queue-list li {
            cursor: pointer;
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            margin-bottom: 0.375rem;
        }
        #queue-list li:last-child {
            margin-bottom: 0;
        }
        #queue-list li:hover {
            background-color: #e2e8f0;
            color: #1a202c;
        }
        /* Added the specific class for selected item */
        #queue-list li.bg-yellow-200-selected {
            background-color: #0692e8;
            color: #2d3748;
        }
        iframe[name="iframe"] {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 0;
            height: 0;
            visibility: hidden;
        }
        /* Style for the large header */
        #studentOutHeader {
             font-size: 5rem; /* ~text-6xl or larger */
             line-height: 1.1;
             color: #030000; /* black */
        }
        
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen" id="body">

    <div id="signInPage" class="flex flex-col items-center justify-center min-h-screen w-full">
        <h1 class="text-4xl font-bold text-white mb-8">Welcome to School Pass System</h1>
        <p class="text-gray-300 mb-6">Please sign in with your Google account to continue.</p>
        <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
        <p class="text-red-500 mt-4 hidden" id="signInError">Sign-in failed. Please try again.</p>
    </div>

    <div id="appContent" class="hidden flex flex-col items-center p-4 min-h-screen w-full">
        <h1 id="studentOutHeader" class="font-bold text-center mb-6 p-2 w-full rounded-lg">
            <span id="studentOutName"></span> PASS IS AVAILABLE
        </h1>

        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative text-sm hidden mb-2 w-2/3" id="alertDiv" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline" id="alertMessage">You have been signed in successfully!</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('alertDiv').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div id="mainContentContainer" class="flex flex-col lg:flex-row items-start lg:items-stretch justify-center w-full max-w-6xl gap-6">

            <form
                id="form"
                class="rounded-lg shadow-xl p-6 w-full lg:w-2/3 space-y-4 flex-shrink-0"
                method="POST"
                target="iframe"
                style="background-color: #4ade80;" /* Initial background for the form (Green) */
                
            >
                <h2 id="passLabel" class="text-2xl font-bold text-gray-800 mb-6 text-center">Bathroom Pass</h2>

              <div class="flex flex-col sm:flex-row items-start sm:items-center">
            <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="teacherNameDisplay">Teacher:</label>
            <div id="teacherNameDisplay"
                class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none static-dropdown">
                <span id= "teacherName" class="static-dropdown-text">Your Teacher's Name Here</span>
                <span class="static-dropdown-arrow"></span>
            </div>
            </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="class">Class:</label>
                    <select id="courseDropdown" onchange="courseChanged()" name="Class"
                        class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="name">Name:</label>
                    <select id="nameDropdown" onchange="nameSelected()" class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex justify-center space-x-3 mt-4">
                    <button id="signOutButton" type="button" 
                        class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign Out
                    </button>
                    <button id="signInButton" type="submit"
                        class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign In
                    </button>
                </div>

                <p class="text-center text-lg font-medium text-gray-800 mt-4">Time: <span id="minutes" class="font-bold">0</span>:<span id="seconds" class="font-bold">00</span></p>
                <textarea id="timeOut" name="Seconds" class="hidden"></textarea>
                <textarea id="nameHolder" name="Name" class="hidden"></textarea>
            </form>

            <div id="rightSideFormsContainer" class="w-full lg:w-1/3 flex flex-col rounded-lg shadow-xl">
                <div class="flex w-full justify-center">
                    <button id="queueViewBtn" class="px-6 py-3 w-1/2 rounded-tl-lg rounded-tr-none font-semibold text-white bg-purple-400 hover:bg-purple-500 focus:outline-none transition-colors duration-200">
                        View Queue
                    </button>
                    <button id="lateSignInViewBtn" class="px-6 py-3 w-1/2 rounded-tl-none rounded-tr-lg font-semibold text-gray-800 bg-yellow-200 hover:bg-yellow-300 focus:outline-none transition-colors duration-200">
                        Late Sign In
                    </button>
                </div>

                <div id="queueArea" class="bg-purple-400 p-6 w-full text-center flex-shrink-0 rounded-b-lg flex-grow hidden">
                    <h2 class="text-2xl font-bold text-black-900 text-center mb-5">Queue for Bathroom</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="nameQueue">Name:</label>
                        <select id="nameQueue"
                            class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                        </select>
                    </div>
                    <button id="add-to-queue"
                        class="mt-4 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none transition-colors duration-200 text-base hidden">
                        Add to Queue
                    </button>

                    <div id="message-area" class="bg-blue-50 border border-blue-200 rounded-md p-4 text-blue-800 mt-4">
                        <p id="message-text" class="hidden text-center text-base font-medium">Please select your name and click 'Add to Queue'.</p>
                        <ol id="queue-list" class="list-decimal list-inside mt-3 text-left text-gray-800 text-base">
                        </ol>
                        <button id="remove-from-queue"
                            class="mt-4 px-5 py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none transition-colors duration-200 text-base hidden">
                            Remove Selected from Queue
                        </button>
                    </div>
                </div>

                <div id="lateSignInView" class="flex flex-col items-center justify-start w-full p-6 rounded-b-lg bg-yellow-200 flex-grow">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Late Sign In</h2>
                    <form id="lateSignInForm" class="w-full space-y-4" method="POST" target="iframe">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center">
                            <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="lateNameDropdown">Name:</label>
                            <select id="lateNameDropdown"  onchange="lateNameSelected()"
                                class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                
                            </select>
                        </div>
                        <div class="flex justify-center mt-6">
                            <button type="submit" id="lateSignInSubmitBtn" class=" hidden px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base">
                                Sign In Late
                            </button>
                        </div>
                        <textarea id="timeOut2" name="Seconds" class="hidden"></textarea>
                        <textarea id="nameHolder2" name="Late" class="hidden"></textarea>
                        <textarea id="classHolder" name="Class" class="hidden"></textarea>

                    </form>
                </div>
            </div>
            
        </div>

    </div>
<button id="googleSignOutButton" class="mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">
                Sign Out of Google
            </button>

    <iframe name="iframe"></iframe>

    <script>
        // --- Google Sign-In Integration ---
        let auth2; // GoogleAuth object

        // Initialize Google Sign-In
        function initGoogleSignIn() {
            gapi.load('auth2', function() {
                auth2 = gapi.auth2.init({
                    client_id: 'YOUR_CLIENT_ID.apps.googleusercontent.com', // Replace with your actual client ID
                    scope: 'profile email'
                });

                // Listen for sign-in state changes
                auth2.isSignedIn.listen(updateSignInStatus);

                // Initial check of sign-in status
                updateSignInStatus(auth2.isSignedIn.get());
            });
        }

        // Callback function for successful sign-in
        function onSignIn(googleUser) {
            console.log('User signed in successfully!');
            const profile = googleUser.getBasicProfile();
            console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail());
            const teacherNameDropdown = document.getElementById("teacherName");
            //teacherNameDropdown.setAttribute("disabled","disabled")
            teacherNameDropdown.textContent=profile.getName();

            // Hide sign-in page and show app content
            document.getElementById('signInPage').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('body').classList.remove('justify-center'); // Remove center alignment for app content

            // You might want to display the signed-in user's name somewhere in the app
            // For now, we'll just proceed to the main app.
            
            // Re-initialize the app content after sign-in
            initializeBathroomPassApp();
        }

        // Handle sign-out
        function signOut() {
            if (auth2) {
                auth2.signOut().then(function () {
                    console.log('User signed out.');
                    // Hide app content and show sign-in page
                    document.getElementById('appContent').classList.add('hidden');
                    document.getElementById('signInPage').classList.remove('hidden');
                    document.getElementById('body').classList.add('justify-center'); // Re-center sign-in page
                    // Reset app state if necessary (e.g., clear timers, queue)
                    resetBathroomPassAppState();
                });
            }
        }

        // Update UI based on sign-in status
        function updateSignInStatus(isSignedIn) {
            if (isSignedIn) {
                console.log('User is currently signed in.');
                document.getElementById('signInPage').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('body').classList.remove('justify-center');
                initializeBathroomPassApp();
            } else {
                console.log('User is currently signed out.');
                document.getElementById('signInPage').classList.remove('hidden');
                document.getElementById('appContent').classList.add('hidden');
                document.getElementById('body').classList.add('justify-center');
                resetBathroomPassAppState();
            }
        }

        // --- Bathroom Pass Application Logic (from original code) ---
        const mainForm = document.getElementById('form');
        const nameDropdown = document.getElementById('nameDropdown');
        const courseDropdown = document.getElementById('courseDropdown');
        const nameQueueDropdown = document.getElementById('nameQueue');
        const studentOutHeader = document.getElementById('studentOutHeader');
        const studentOutName = document.getElementById('studentOutName');

        const queueArea = document.getElementById('queueArea'); // Bathroom Pass Queue
        const lateSignInView = document.getElementById('lateSignInView'); // Late Sign In Form
        const queueViewBtn = document.getElementById('queueViewBtn'); // New button for Queue
        const lateSignInViewBtn = document.getElementById('lateSignInViewBtn'); // Existing button, renamed for clarity

        const lateNameDropdown = document.getElementById('lateNameDropdown');
        const lateSignInForm = document.getElementById('lateSignInForm'); // Get the late form

        let seconds = 0;
        let minutes = 0;
        let timerInterval = null;
        let queue = [];
        let selectedName = null;
        let currentlySignedOutStudent = null;
        let allNamesData = []; // Store all names data once fetched

        function updateTimer() {
            seconds++;
            const TARDY_TIME = 5
            document.getElementById("timeOut").value = (minutes * 60) + seconds;
            if (seconds >= 60) {
                minutes++;
                seconds = 0;
            }
            if (minutes >= TARDY_TIME) {
                mainForm.style.backgroundColor = "#ef4444"; // Red
                studentOutHeader.style.backgroundColor = "#ef4444";

            }
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = seconds < 10 ? "0" + seconds : seconds;
        }

        document.getElementById("signOutButton").addEventListener("click", function() {
            if (!timerInterval) {
                timerInterval = setInterval(updateTimer, 1000);
                this.style.display = "none";
                document.getElementById("signInButton").style.display = "block";
                nameDropdown.setAttribute("disabled", "disabled");
                courseDropdown.setAttribute("disabled", "disabled");
                mainForm.style.backgroundColor = "#f6b26b"; // Orange

                const fullString = nameDropdown.value;
                const nameOnly = fullString.includes("(") ? fullString.substring(0, fullString.indexOf("(")-1) : fullString;
                document.getElementById("nameHolder").value = nameOnly; // Use nameHolder for sign out

                studentOutHeader.textContent = `${nameOnly} IS OUT`; // Set the full text
                studentOutHeader.style.backgroundColor = "#f6b26b"; // Orange for "IS OUT"

                currentlySignedOutStudent = fullString;
                // Update message and show queue automatically
                updateQueueDisplay();
                showQueueView(); // Automatically switch to queue view
                updateToggleButtonVisibility(); // Update button visibility

                setUpDropdown2('nameQueue', uniqueNames);
                nameQueueDropdown.value = 'Select Your Name';
                nameQueueDropdown.removeAttribute('disabled');
                toggleAddToQueueButton();
            }
        });

        // Event listener for Bathroom Sign In
        mainForm.addEventListener("submit", function() {
            clearInterval(timerInterval);
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signInButton").style.display = "none";
            document.getElementById("signOutButton").style.display = "none";
            courseDropdown.removeAttribute("disabled");
            mainForm.style.backgroundColor = "#4ade80"; // Green

            // Show success alert
            document.getElementById("alertDiv").classList.remove("hidden");
            document.getElementById("alertMessage").textContent = `${currentlySignedOutStudent} has been signed in successfully!`;
            setTimeout(() => document.getElementById("alertDiv").classList.add('hidden'), 5000);

            currentlySignedOutStudent = null;
            
            if (queue.length > 0) {
                const nextPerson = queue.shift();
                nameDropdown.value = nextPerson;
                nameDropdown.setAttribute("disabled", "disabled");
                updateMessage(`${nextPerson} can now sign out.`);
                updateQueueDisplay();
                nameSelected();

                studentOutName.textContent = nextPerson;
                studentOutHeader.textContent = `${nextPerson} IS NEXT`; // Set the full text
                studentOutHeader.style.backgroundColor = "#4ade80"; // Green for "IS NEXT"

                showQueueView(); // Keep queue view active
            } else {
                nameDropdown.value = 'Select Your Name';
                nameDropdown.removeAttribute("disabled");
                document.getElementById("signOutButton").style.display = "none";
                updateMessage('The queue is empty. No one is currently signed out.');
                // Update header to "PASS IS AVAILABLE"
                studentOutHeader.textContent = "PASS IS AVAILABLE";
                studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass
                studentOutName.textContent = '';
                nameQueueDropdown.setAttribute("disabled", "disabled"); //Disable the queue dropdown

                showLateSignInView(); // Switch back to late sign-in view
            }
            toggleAddToQueueButton();
            updateToggleButtonVisibility(); // Update button visibility
        });

        // Event listener for Late Sign In form submission
        lateSignInForm.addEventListener('submit', function(event) {
            const selectedLateName = lateNameDropdown.value;

            // Prevent submission if "Select Your Name" is still chosen
            if (selectedLateName === 'Select Your Name' || selectedLateName.trim() === '') {
                event.preventDefault(); // Stop the form from submitting
                // Display a more prominent message to the user
                document.getElementById("alertDiv").classList.remove("hidden");
                document.getElementById("alertDiv").classList.add("bg-red-100", "border-red-400", "text-red-700");
                document.getElementById("alertDiv").classList.remove("bg-green-100", "border-green-400", "text-green-700");
                document.getElementById("alertMessage").textContent = `Please select a valid name to sign in late.`;
                setTimeout(() => {
                    document.getElementById("alertDiv").classList.add("hidden");
                    // Reset to green after alert
                    document.getElementById("alertDiv").classList.remove("bg-red-100", "border-red-400", "text-red-700");
                    document.getElementById("alertDiv").classList.add("bg-green-100", "border-green-400", "text-green-700");
                }, 5000);
            } else {
                const nameOnly2 = selectedLateName.includes("(") ? selectedLateName.substring(0, selectedLateName.indexOf("(")-1) : selectedLateName;
                document.getElementById("nameHolder2").value = nameOnly2; // Use nameHolder for sign out

                document.getElementById("alertDiv").classList.remove("hidden");
                document.getElementById("alertDiv").classList.remove("bg-red-100", "border-red-400", "text-red-700"); // Ensure it's green for success
                document.getElementById("alertDiv").classList.add("bg-green-100", "border-green-400", "text-green-700");
                document.getElementById("alertMessage").textContent = `${selectedLateName} has been signed in late successfully!`;
                setTimeout(() => document.getElementById("alertDiv").classList.add("hidden"), 5000);

                // Reset the dropdown after a short delay to allow submission
                setTimeout(() => {
                    lateNameDropdown.value = 'Select Your Name';
                    document.getElementById("lateSignInSubmitBtn").classList.add("hidden")
                }, 100);
            }
        });


        function getNumberFromName(name) {
            const match = name.match(/\((\d+)\)$/);
            return match ? parseInt(match[1]) : Infinity;
        }

        function updateMessage(message) {
            document.getElementById('message-text').textContent = message;
        }

        function updateQueueDisplay() {
            const queueList = document.getElementById('queue-list');
            const removeFromQueueButton = document.getElementById('remove-from-queue');

            queueList.innerHTML = '';
            selectedName = null;
            removeFromQueueButton.classList.add('hidden');

            if (queue.length === 0) {
                queueList.style.display = 'none';
                if (!currentlySignedOutStudent) {
                   updateMessage('The queue is currently empty. Add your name!');
                } else {
                   updateMessage('No one else is in queue. Select your name below to add.');
                }
            } else {
                queueList.style.display = 'block';
                updateMessage('Please select a name from the list to remove, or add another.');

                queue.sort((a, b) => getNumberFromName(a) - getNumberFromName(b));

                queue.forEach((person) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${person}`;
                    listItem.addEventListener('click', () => {
                        Array.from(queueList.children).forEach(item => {
                            item.classList.remove('bg-yellow-200-selected');
                        });
                        selectedName = person;
                        listItem.classList.add('bg-yellow-200-selected');
                        removeFromQueueButton.classList.remove('hidden');
                    });
                    queueList.appendChild(listItem);
                });
            }
            toggleAddToQueueButton();
            updateToggleButtonVisibility(); // Update button visibility
        }

        function toggleAddToQueueButton() {
            const addToQueueButton = document.getElementById('add-to-queue');
            if (nameQueueDropdown.value === 'Select Your Name' || nameQueueDropdown.value.trim() === '') {
                addToQueueButton.classList.add('hidden');
            } else {
                addToQueueButton.classList.remove('hidden');
            }
        }

        nameQueueDropdown.addEventListener('change', toggleAddToQueueButton);

        document.getElementById('add-to-queue').addEventListener('click', () => {
            const name = nameQueueDropdown.value.trim();

            if (name === 'Select Your Name' || name === '') {
                updateMessage('Please select your name to add to the queue.');
            } else if (queue.includes(name)) {
                updateMessage('You are already in the queue.');
            } else if (currentlySignedOutStudent && name === currentlySignedOutStudent) {
                updateMessage(`${name} is currently signed out and cannot be added to the queue.`);
            } else {
                queue.push(name);
                updateMessage(`${name} has been added to the queue.`);
                updateQueueDisplay();
                nameQueueDropdown.value = 'Select Your Name';
                toggleAddToQueueButton();
                // Ensure queue is visible if something is added and no one is out
                if (!currentlySignedOutStudent) {
                    showQueueView();
                }
            }
            updateToggleButtonVisibility(); // Update button visibility
        });

        document.getElementById('remove-from-queue').addEventListener('click', () => {
            if (queue.length === 0) {
                updateMessage('The queue is already empty.');
            } else if (!selectedName) {
                updateMessage('Please select a name from the list to remove.');
            } else {
                const index = queue.indexOf(selectedName);
                if (index > -1) {
                    queue.splice(index, 1);
                    updateMessage(`Removed ${selectedName} from the queue.`);
                    updateQueueDisplay();
                } else {
                    updateMessage('Error: Name not found in queue.');
                }
                if (queue.length === 0 && !currentlySignedOutStudent) {
                    showLateSignInView(); // Go back to late sign-in if queue is empty and no one is out
                }
            }
            updateToggleButtonVisibility(); // Update button visibility
        });

        // Function to initialize the bathroom pass app content
        function initializeBathroomPassApp() {
            const alertDiv = document.getElementById("alertDiv");
            if (alertDiv) {
                alertDiv.classList.add("hidden");
            }

            // Set initial state for studentOutHeader
            studentOutHeader.textContent = "PASS IS AVAILABLE";
            studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass

            updateQueueDisplay();
            toggleAddToQueueButton();

            setUpDropdown('courseDropdown', [], "Loading...");
            courseDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameDropdown', [], "Select Your Name");
            nameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameQueue', [], "Select Your Name");
            nameQueueDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('lateNameDropdown', [], "Select Your Name"); // Will be populated with uniqueNames later
            lateNameDropdown.setAttribute("disabled", "disabled"); // Ensure it's disabled initially

            document.getElementById("signOutButton").style.display = "none";

            fetchClassData();
            fetchAllNames(); // Fetch all names on load
            showLateSignInView(); // Set initial right-side view to Late Sign In
            updateToggleButtonVisibility(); // Initial button visibility update
        }

        // Function to reset the bathroom pass app state on sign-out
        function resetBathroomPassAppState() {
            clearInterval(timerInterval);
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            queue = [];
            selectedName = null;
            currentlySignedOutStudent = null;
            allNamesData = [];

            // Reset UI elements
            document.getElementById("minutes").textContent = "0";
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signInButton").style.display = "none";
            document.getElementById("signOutButton").style.display = "none";
            courseDropdown.removeAttribute("disabled"); // Re-enable for next sign-in
            mainForm.style.backgroundColor = "#4ade80"; // Green
            studentOutHeader.textContent = "PASS IS AVAILABLE";
            studentOutHeader.style.backgroundColor = "#4ade80";
            studentOutName.textContent = '';
            
            // Clear dropdowns
            setUpDropdown('courseDropdown', [], "Select Class");
            setUpDropdown2('nameDropdown', [], "Select Your Name");
            setUpDropdown2('nameQueue', [], "Select Your Name");
            setUpDropdown2('lateNameDropdown', [], "Select Your Name");

            // Hide queue and show late sign-in by default
            showLateSignInView();
            updateQueueDisplay(); // Clear queue display
        }


        const url = "https://script.google.com/macros/s/AKfycbzIalB21jM1-vuBfJTpRjtwMc1jJYe0XL5SqCozJCzyNrpd6SBF0Mh_RXITRY5yC-Po/exec"
        document.getElementById('form').action = url;
        document.getElementById('lateSignInForm').action = url;
        let classes = [];
        let uniqueCourses = [];
        let uniqueNames = []; // For Bathroom Pass and Late Sign In Name dropdowns
        let allNames = []; // Store all names data {name: "...", class: "..."}


        function fetchClassData() {
            fetch(`${url}?header=Class`)
                .then((response) => response.json())
                .then(({ data }) => {
                    classes = data; // Keep the original classes array
                    populateDatalists("classes", data);
                    courseDropdown.removeAttribute("disabled");
                    courseDropdown.value = "";
                })
                .catch((error) => {
                    console.error('Error fetching class data:', error);
                    setUpDropdown('courseDropdown', [], "Error loading classes");
                });
        }

       // Fetch ALL names and classes to filter locally
        function fetchAllNames() {
            fetch(`${url}?action=getAllData`) // Assumes your Apps Script can handle this
                .then(response => response.json())
                .then(data => {
                    // Ensure data is an array before processing
                    if (Array.isArray(data)) {
                        allNames = data; // e.g., [{Class: "Math", Name: "Alice"}, {Class: "Sci", Name: "Bob"}]
                        const allUniqueNames = new Set();
                        allUniqueNames.add("Select Your Name");
                        data.forEach(item => {
                            if (typeof item === 'string') {
                                allUniqueNames.add(item);
                            } else if (item && item.Name) {
                                allUniqueNames.add(item.Name);
                            }
                        });
                        uniqueNames = Array.from(allUniqueNames); // Update uniqueNames for all relevant dropdowns
                        setUpDropdown2('lateNameDropdown', uniqueNames); // Populate late name dropdown
                    } else {
                        console.error('Error: fetchAllNames received non-array data:', data);
                        allNames = []; // Reset to empty array to prevent further errors
                        setUpDropdown2('lateNameDropdown', [], "Select Your Name");
                        document.getElementById('lateNameDropdown').setAttribute("disabled", "disabled");
                    }
                })
                .catch(error => console.error('Error fetching all names:', error));
        }


        const populateDatalists = (id, arr) => {
            const uniqueItems = new Set();
            for (const item of arr) {
                uniqueItems.add(item);
            }
            uniqueCourses = Array.from(uniqueItems);
            setUpDropdown('courseDropdown', uniqueCourses);
        };

        // Populates Bathroom Pass and Queue Names
        const populateDatalists2 = (arr, courseName) => {
            const uniqueItems = new Set();
            uniqueItems.add("Select Your Name");
            for (let i = 0; i < classes.length; i++) {
                if (classes[i] === courseName && arr[i]) {
                    uniqueItems.add(arr[i]);
                }
            }
            uniqueNames = Array.from(uniqueItems); // Specific to Bathroom Pass
            setUpDropdown2('nameDropdown', uniqueNames);
            setUpDropdown2('nameQueue', uniqueNames);
            setUpDropdown2('lateNameDropdown', uniqueNames); // Also update late sign-in name dropdown
        };


        function removeOptions(selectElement) {
            while (selectElement.options.length > 0) {
                selectElement.remove(0);
            }
        }

       // For Bathroom Pass Class Change
        function courseChanged(){
            if (courseDropdown.value !== "") {
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameDropdown', [], "Loading...");
                nameQueueDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Loading...");
                lateNameDropdown.removeAttribute("disabled"); // Enable late name dropdown
                setUpDropdown2('lateNameDropdown', [], "Loading..."); // Still show loading while names update
                updateNameDropdown();
            } else {
                setUpDropdown2('nameDropdown', [], "Select Your Name");
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Select Your Name");
                nameQueueDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('lateNameDropdown', [], "Select Your Name"); // Reset late name dropdown
                lateNameDropdown.setAttribute("disabled", "disabled"); // Ensure it's disabled
                document.getElementById("signOutButton").style.display = "none";
            }
            updateToggleButtonVisibility(); // Update button visibility
        }

       // Fetches & updates Bathroom Pass names
        function updateNameDropdown() {
            document.getElementById("signOutButton").style.display = "none";
            document.getElementById("signInButton").style.display = "none";

            fetch(`${url}?header=Name`)
                .then((response) => response.json())
                .then(({ data }) => {
                    // Populate all relevant dropdowns with the names filtered by the selected class
                    populateDatalists2(data, courseDropdown.value); 
                    nameDropdown.removeAttribute("disabled");
                    //nameQueueDropdown.removeAttribute("disabled"); // This line might be problematic if it's not always enabled
                    lateNameDropdown.removeAttribute("disabled"); // Enable late name dropdown
                    nameDropdown.value = 'Select Your Name';
                    nameQueueDropdown.value = 'Select Your Name';
                    lateNameDropdown.value = 'Select Your Name'; // Reset late name dropdown
                    toggleAddToQueueButton();
                })
                .catch((error) => {
                    console.error('Error fetching name data:', error);
                    setUpDropdown2('nameDropdown', [], "Error loading names");
                    setUpDropdown2('nameQueue', [], "Error loading names");
                    setUpDropdown2('lateNameDropdown', [], "Error loading names");
                });
        }


        function nameSelected(){
            if(nameDropdown.value === "Select Your Name" || timerInterval !== null || nameDropdown.value === currentlySignedOutStudent){
                document.getElementById("signOutButton").style.display = "none";
            } else {
                document.getElementById("signOutButton").style.display = "block";
            }
            document.getElementById("signInButton").style.display = timerInterval !== null ? "block" : "none";
            updateToggleButtonVisibility(); // Update button visibility
        }

        function lateNameSelected(){
            document.getElementById("lateSignInSubmitBtn").classList.remove("hidden");
            document.getElementById("classHolder").textContent = courseDropdown.value;
          
        }

        function setUpDropdown(dropdownId, arr, defaultText = "Select Class") {
            let selectElement = document.getElementById(dropdownId);
            removeOptions(selectElement);
            selectElement.add(new Option(defaultText, ""));
            arr.forEach(str => {
                selectElement.add(new Option(str, str));
            });
            selectElement.disabled = (arr.length === 0 && defaultText.includes("Loading..."));
        }

        function setUpDropdown2(dropdownId, arr, defaultText = "Select Your Name") {
            let selectElement = document.getElementById(dropdownId);
            removeOptions(selectElement);
            selectElement.add(new Option(defaultText, "Select Your Name"));
            arr.forEach(str => {
                if (str !== "Select Your Name") {
                    selectElement.add(new Option(str, str));
                }
            });
            // Only disable if loading or if it's explicitly set
            //selectElement.disabled = (arr.length === 0 && defaultText.includes("Loading..."));
        }

        // Functions to toggle the right-side views and button styles
        function showQueueView() {
            queueArea.classList.remove('hidden');
            lateSignInView.classList.add('hidden');

            // Set Queue button to active style (purple)
            queueViewBtn.classList.add('bg-purple-400', 'text-white');
            queueViewBtn.classList.remove('bg-gray-300', 'text-gray-800'); 

            // Set Late Sign In button to its inactive style (yellow)
            lateSignInViewBtn.classList.add('bg-yellow-200', 'text-gray-800');
            lateSignInViewBtn.classList.remove('bg-gray-300', 'text-white'); 
        }

        function showLateSignInView() {
            queueArea.classList.add('hidden');
            lateSignInView.classList.remove('hidden');

            // Set Late Sign In button to active style (yellow)
            lateSignInViewBtn.classList.add('bg-yellow-200', 'text-gray-800');
            lateSignInViewBtn.classList.remove('bg-gray-300', 'text-white'); 

            // Set Queue button to its inactive style (purple)
            queueViewBtn.classList.add('bg-purple-400', 'text-white');
            queueViewBtn.classList.remove('bg-gray-300', 'text-gray-800'); 
        }

        // Function to control the visibility of the toggle buttons
        function updateToggleButtonVisibility() {
            // This function is now simplified as buttons are always visible in HTML.
            // Their visibility is controlled by the initial HTML structure.
            // The active/inactive state is handled by showQueueView/showLateSignInView.
        }

        // Event listeners for the new toggle buttons
        queueViewBtn.addEventListener('click', showQueueView);
        lateSignInViewBtn.addEventListener('click', showLateSignInView);

        // Add event listener for the new Google Sign Out button
        document.getElementById('googleSignOutButton').addEventListener('click', signOut);

        // Initialize Google Sign-In when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initGoogleSignIn);
    </script>
</body>
</html>
