<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="683459371071-7bm37ul6uatesp6g5nsf8lu1mnl9pnjm.apps.googleusercontent.com">
    <title>School Pass System by Jander</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
    >

    <script type="text/javascript">
    // This function prompts the user before leaving the page.
    window.onbeforeunload = function() {
        // Only prompt if a student is currently signed out (timer is running)
        if (timerInterval) {
            return "Are you sure you want to leave? The current pass timer will be stopped and status might be lost!";
        }
        // No prompt if no one is signed out or pass is available
    }
    </script>

    <style>
        /* Body font and background color */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1d1d; /* Dark background for the page */
        }
        /* Form text size and transition */
        form {
            font-size: 1.125rem; /* text-lg */
            transition: background-color 0.5s ease; /* Smooth transition for form color changes */
        }
        /* Select element text size */
        select {
            font-size: 1.125rem; /* text-lg for consistency with form text */
        }
        /* Remove default focus styles from select elements */
        select:focus {
            outline: none;
            border-color: #d1d5db; /* Revert to default border color on focus */
            box-shadow: none; /* Remove any box shadow on focus */
        }
        /* Styling for queue list items */
        #queue-list li {
            cursor: pointer;
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            margin-bottom: 0.375rem;
        }
        /* No bottom margin for the last item in the queue list */
        #queue-list li:last-child {
            margin-bottom: 0;
        }
        /* Hover effect for queue list items */
        #queue-list li:hover {
            background-color: #e2e8f0;
            color: #1a202c;
        }
        /* Specific class for selected item in the queue */
        #queue-list li.bg-yellow-200-selected {
            background-color: #0692e8; /* A distinct blue for selected item */
            color: #2d3748;
        }
        /* Hidden iframe for form submissions (Google Apps Script) */
        iframe[name="iframe"] {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 0;
            height: 0;
            visibility: hidden;
        }
        /* Style for the large header displaying pass status */
        #studentOutHeader {
             font-size: 5rem; /* Large text size */
             line-height: 1.1;
             color: #030000; /* Black text */
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen" id="body">

    <div id="googleSignInContainer" class="flex flex-col items-center justify-center min-h-screen w-full">
        <h2 class="text-3xl font-bold text-white mb-6 text-center">Please Sign In to Access the Pass System</h2>
        <div class="g-signin2" data-onsuccess="onSignIn" data-width="240" data-height="50" data-longtitle="true"></div>
    </div>

    <div id="appContent" class="hidden flex flex-col items-center w-full">
        <h1 id="studentOutHeader" class="font-bold text-center mb-6 p-2 w-full rounded-lg">
            <span id="studentOutName"></span> PASS IS AVAILABLE
        </h1>

        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative text-sm hidden mb-2 w-2/3" id="alertDiv" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline" id="alertMessage">You have been signed in successfully!</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('alertDiv').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div id="mainContentContainer" class="flex flex-col lg:flex-row items-start lg:items-stretch justify-center w-full max-w-6xl gap-6">

            <form
                id="form"
                class="rounded-lg shadow-xl p-6 w-full lg:w-2/3 space-y-4 flex-shrink-0"
                method="POST"
                target="iframe"
                style="background-color: #4ade80;" /* Initial background for the form (Green) */
            >
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Bathroom Pass</h2>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="class">Class:</label>
                    <select id="courseDropdown" onchange="courseChanged()" name="Class"
                        class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="name">Name:</label>
                    <select id="nameDropdown" onchange="nameSelected()" class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex justify-center space-x-3 mt-4">
                    <button id="signOutButton" type="button"
                        class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign Out
                    </button>
                    <button id="signInButton" type="submit"
                        class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign In
                    </button>
                </div>

                <p class="text-center text-lg font-medium text-gray-800 mt-4">Time: <span id="minutes" class="font-bold">0</span>:<span id="seconds" class="font-bold">00</span></p>
                <textarea id="timeOut" name="Seconds" class="hidden"></textarea>
                <textarea id="nameHolder" name="Name" class="hidden"></textarea>
                <input type="hidden" id="teacherEmailInput" name="TeacherEmail">
            </form>

            <div id="rightSideFormsContainer" class="w-full lg:w-1/3 flex flex-col rounded-lg shadow-xl">
                <div class="flex w-full justify-center">
                    <button id="queueViewBtn" class="px-6 py-3 w-1/2 rounded-tl-lg rounded-tr-none font-semibold text-white bg-purple-400 hover:bg-purple-500 focus:outline-none transition-colors duration-200">
                        View Queue
                    </button>
                    <button id="lateSignInViewBtn" class="px-6 py-3 w-1/2 rounded-tl-none rounded-tr-lg font-semibold text-gray-800 bg-yellow-200 hover:bg-yellow-300 focus:outline-none transition-colors duration-200">
                        Late Sign In
                    </button>
                </div>

                <div id="queueArea" class="bg-purple-400 p-6 w-full text-center flex-shrink-0 rounded-b-lg flex-grow hidden">
                    <h2 class="text-2xl font-bold text-black-900 text-center mb-5">Queue for Bathroom</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="nameQueue">Name:</label>
                        <select id="nameQueue"
                            class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                        </select>
                    </div>
                    <button id="add-to-queue"
                        class="mt-4 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none transition-colors duration-200 text-base hidden">
                        Add to Queue
                    </button>

                    <div id="message-area" class="bg-blue-50 border border-blue-200 rounded-md p-4 text-blue-800 mt-4">
                        <p id="message-text" class="hidden text-center text-base font-medium">Please select your name and click 'Add to Queue'.</p>
                        <ol id="queue-list" class="list-decimal list-inside mt-3 text-left text-gray-800 text-base">
                        </ol>
                        <button id="remove-from-queue"
                            class="mt-4 px-5 py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none transition-colors duration-200 text-base hidden">
                            Remove Selected from Queue
                        </button>
                    </div>
                </div>

                <div id="lateSignInView" class="flex flex-col items-center justify-start w-full p-6 rounded-b-lg bg-yellow-200 flex-grow">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Late Sign In</h2>
                    <form id="lateSignInForm" class="w-full space-y-4" method="POST" target="iframe">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center">
                            <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="lateNameDropdown">Name:</label>
                            <select id="lateNameDropdown"  onchange="lateNameSelected()"
                                class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">

                            </select>
                        </div>
                        <div class="flex justify-center mt-6">
                            <button type="submit" id="lateSignInSubmitBtn" class=" hidden px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base">
                                Sign In Late
                            </button>
                        </div>
                        <textarea id="timeOut2" name="Seconds" class="hidden"></textarea>
                        <textarea id="nameHolder2" name="Late" class="hidden"></textarea>
                        <textarea id="classHolder" name="Class" class="hidden"></textarea>
                        <input type="hidden" id="teacherEmailInputLate" name="TeacherEmail">
                    </form>
                </div>
            </div>

        </div>

        <iframe name="iframe"></iframe>

        <a href="#" onclick="signOut(); return false;" class="mt-8 text-blue-400 hover:text-blue-600">Sign out of Google</a>
    </div>

    <script>
        // Global variables for the application
        const mainForm = document.getElementById('form');
        const nameDropdown = document.getElementById('nameDropdown');
        const courseDropdown = document.getElementById('courseDropdown');
        const nameQueueDropdown = document.getElementById('nameQueue');
        const studentOutHeader = document.getElementById('studentOutHeader');
        const studentOutName = document.getElementById('studentOutName');
        const teacherEmailInput = document.getElementById('teacherEmailInput');
        const teacherEmailInputLate = document.getElementById('teacherEmailInputLate');

        const queueArea = document.getElementById('queueArea');
        const lateSignInView = document.getElementById('lateSignInView');
        const queueViewBtn = document.getElementById('queueViewBtn');
        const lateSignInViewBtn = document.getElementById('lateSignInViewBtn');

        const lateNameDropdown = document.getElementById('lateNameDropdown');
        const lateSignInForm = document.getElementById('lateSignInForm');

        let seconds = 0;
        let minutes = 0;
        let timerInterval = null;
        let queue = [];
        let selectedName = null;
        let currentlySignedOutStudent = null;
        let allNamesData = []; // This seems unused, consider removing if not needed.
        let classes = [];
        let uniqueCourses = [];
        let uniqueNames = []; // Used for course-specific names
        let allNames = []; // Used for all names for late sign-in
        let signedInUserEmail = null;

        // Google Sign-In callback function
        function onSignIn(googleUser) {
            console.log('[DEBUG] onSignIn function started.');
            if (!googleUser) {
                console.error('[DEBUG] googleUser object is null or undefined in onSignIn.');
                // Display an error to the user if appropriate
                // Example: alert('Google Sign-In failed: No user data received.');
                return; // Critical error, cannot proceed
            }

            var profile = googleUser.getBasicProfile();
            if (!profile) {
                console.error('[DEBUG] Google user profile is null or undefined in onSignIn.');
                // Example: alert('Google Sign-In failed: Could not retrieve user profile.');
                return; // Stop execution if profile is not available
            }
            console.log('[DEBUG] Profile object:', profile);
            console.log('ID: ' + profile.getId());
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail());

            signedInUserEmail = profile.getEmail();
            if (!signedInUserEmail) {
                console.warn('[DEBUG] Signed in user email is null or undefined. Some features might be limited.');
                // Decide if we should return or try to proceed. For now, we proceed but log a warning.
            }
            console.log('[DEBUG] User email stored:', signedInUserEmail);

            if (teacherEmailInput) {
                teacherEmailInput.value = signedInUserEmail || '';
            } else {
                console.error('[DEBUG] teacherEmailInput element not found in onSignIn.');
            }
            if (teacherEmailInputLate) {
                teacherEmailInputLate.value = signedInUserEmail || '';
            } else {
                console.error('[DEBUG] teacherEmailInputLate element not found in onSignIn.');
            }


            const signInContainer = document.getElementById('googleSignInContainer');
            const appContentDiv = document.getElementById('appContent');

            if (signInContainer) {
                console.log('[DEBUG] Hiding Google Sign-In container.');
                signInContainer.classList.add('hidden');
            } else {
                console.error('[DEBUG] googleSignInContainer not found!');
            }

            if (appContentDiv) {
                console.log('[DEBUG] Showing App Content.');
                appContentDiv.classList.remove('hidden');
                console.log('[DEBUG] appContent classList after remove hidden:', appContentDiv.classList.toString());
            } else {
                console.error('[DEBUG] appContent div not found!');
            }

            console.log('[DEBUG] Calling initializeAppDataAndUI().');
            try {
                initializeAppDataAndUI();
                console.log('[DEBUG] initializeAppDataAndUI() finished successfully.');
            } catch (error) {
                console.error('[DEBUG] Error during initializeAppDataAndUI():', error);
                // Optionally, display a user-friendly error message on the page
                // alert('An error occurred while initializing the application. Please try again.');
            }
        }

        // Function to sign out of Google
        function signOut() {
            try {
                var auth2 = gapi.auth2.getAuthInstance();
                if (auth2) {
                    auth2.signOut().then(function () {
                        console.log('[DEBUG] User signed out successfully from Google.');
                        // Hide the main application content
                        const appContentDiv = document.getElementById('appContent');
                        if (appContentDiv) appContentDiv.classList.add('hidden');

                        // Show the Google Sign-In container
                        const signInContainer = document.getElementById('googleSignInContainer');
                        if (signInContainer) signInContainer.classList.remove('hidden');

                        resetAppState();
                        console.log('[DEBUG] App state reset after sign out.');
                    }).catch(function(error) {
                        console.error('[DEBUG] Error during Google signOut():', error);
                    });
                } else {
                    console.warn('[DEBUG] Google Auth instance not found during signOut. Forcing UI reset.');
                    // Force UI reset if gapi not fully available
                    const appContentDiv = document.getElementById('appContent');
                    if (appContentDiv) appContentDiv.classList.add('hidden');
                    const signInContainer = document.getElementById('googleSignInContainer');
                    if (signInContainer) signInContainer.classList.remove('hidden');
                    resetAppState();
                }
            } catch (error) {
                console.error('[DEBUG] Exception in signOut function:', error);
                 // Force UI reset as a fallback
                const appContentDiv = document.getElementById('appContent');
                if (appContentDiv) appContentDiv.classList.add('hidden');
                const signInContainer = document.getElementById('googleSignInContainer');
                if (signInContainer) signInContainer.classList.remove('hidden');
                resetAppState();
            }
        }

        // Function to reset application state on sign out
        function resetAppState() {
            console.log('[DEBUG] resetAppState started.');
            clearInterval(timerInterval);
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            queue = [];
            selectedName = null;
            currentlySignedOutStudent = null;
            // allNamesData = []; // Already commented as potentially unused
            classes = [];
            uniqueCourses = [];
            uniqueNames = [];
            allNames = [];
            signedInUserEmail = null;

            if (teacherEmailInput) teacherEmailInput.value = '';
            if (teacherEmailInputLate) teacherEmailInputLate.value = '';


            document.getElementById("minutes").textContent = "0";
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signOutButton").style.display = "none";
            document.getElementById("signInButton").style.display = "none";

            if (courseDropdown) {
                courseDropdown.innerHTML = ''; // Clear options
                setUpDropdown('courseDropdown', [], "Select Class");
                courseDropdown.setAttribute("disabled", "disabled");
            }
            if (mainForm) mainForm.style.backgroundColor = "#4ade80"; // Green

            if (studentOutHeader) {
                 studentOutHeader.textContent = "PASS IS AVAILABLE";
                 studentOutHeader.style.backgroundColor = "#4ade80"; // Green
            }
            if (studentOutName) studentOutName.textContent = '';

            if (nameDropdown) {
                nameDropdown.innerHTML = ''; // Clear options
                setUpDropdown2('nameDropdown', [], "Select Your Name");
                nameDropdown.setAttribute("disabled", "disabled");
            }
             if (nameQueueDropdown) {
                nameQueueDropdown.innerHTML = ''; // Clear options
                setUpDropdown2('nameQueue', [], "Select Your Name");
                nameQueueDropdown.setAttribute("disabled", "disabled");
            }
            if (lateNameDropdown) {
                lateNameDropdown.innerHTML = ''; // Clear options
                 setUpDropdown2('lateNameDropdown', [], "Select Your Name");
                lateNameDropdown.setAttribute("disabled", "disabled");
            }

            updateQueueDisplay();
            showLateSignInView(); // Default view
            updateToggleButtonVisibility();
            console.log('[DEBUG] resetAppState finished.');
        }

        // This function will be called once the Google user is signed in
        function initializeAppDataAndUI() {
            console.log('[DEBUG] initializeAppDataAndUI function started.');
            const alertDiv = document.getElementById("alertDiv");
            if (alertDiv) {
                alertDiv.classList.add("hidden");
            }

            studentOutHeader.textContent = "PASS IS AVAILABLE";
            studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass

            setUpDropdown('courseDropdown', [], "Loading...");
            courseDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameDropdown', [], "Select Your Name");
            nameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameQueue', [], "Select Your Name");
            nameQueueDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('lateNameDropdown', [], "Select Your Name");
            lateNameDropdown.setAttribute("disabled", "disabled");

            document.getElementById("signOutButton").style.display = "none";

            fetchClassData();
            fetchAllNames(); // This populates 'allNames' and 'lateNameDropdown'
            updateQueueDisplay();
            showLateSignInView();
            updateToggleButtonVisibility();
            console.log('[DEBUG] initializeAppDataAndUI function completed basic setup. Fetch calls initiated.');
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DEBUG] DOMContentLoaded event fired.');
            const appContentOnLoad = document.getElementById('appContent');
            const signInContainerOnLoad = document.getElementById('googleSignInContainer');

            if (appContentOnLoad) {
                appContentOnLoad.classList.add('hidden');
                console.log('[DEBUG] appContent hidden on DOMContentLoaded.');
            } else {
                console.error('[DEBUG] appContent not found on DOMContentLoaded.');
            }

            if (signInContainerOnLoad) {
                signInContainerOnLoad.classList.remove('hidden');
                console.log('[DEBUG] googleSignInContainer shown on DOMContentLoaded.');
            } else {
                console.error('[DEBUG] googleSignInContainer not found on DOMContentLoaded.');
            }
            // It's good practice to ensure gapi is loaded before trying to use auth2 instance,
            // especially for manual signOut calls. The g-signin2 button handles its own initialization.
            gapi.load('auth2', function() {
                console.log('[DEBUG] Google Auth2 library loaded via gapi.load.');
                // You could initialize auth2 here if not using g-signin2 for some reason
                // gapi.auth2.init({ client_id: 'YOUR_CLIENT_ID.apps.googleusercontent.com' });
            });
        });

        // Timer update function
        function updateTimer() {
            seconds++;
            const TARDY_TIME = 5; // Time in minutes after which the pass turns red
            document.getElementById("timeOut").value = (minutes * 60) + seconds;
            if (seconds >= 60) {
                minutes++;
                seconds = 0;
            }
            if (minutes >= TARDY_TIME) {
                mainForm.style.backgroundColor = "#ef4444"; // Red
                studentOutHeader.style.backgroundColor = "#ef4444";
            }
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = seconds < 10 ? "0" + seconds : seconds;
        }

        // Event listener for Bathroom Sign Out button
        document.getElementById("signOutButton").addEventListener("click", function() {
            if (!timerInterval) {
                timerInterval = setInterval(updateTimer, 1000);
                this.style.display = "none";
                document.getElementById("signInButton").style.display = "block";
                nameDropdown.setAttribute("disabled", "disabled");
                courseDropdown.setAttribute("disabled", "disabled");
                mainForm.style.backgroundColor = "#f6b26b"; // Orange

                const fullString = nameDropdown.value;
                const nameOnly = fullString.includes("(") ? fullString.substring(0, fullString.indexOf("(")-1) : fullString;
                document.getElementById("nameHolder").value = nameOnly;

                studentOutHeader.textContent = `${nameOnly} IS OUT`;
                studentOutHeader.style.backgroundColor = "#f6b26b"; // Orange

                currentlySignedOutStudent = fullString;
                updateQueueDisplay();
                showQueueView();
                updateToggleButtonVisibility();

                // Populate queue dropdown with names from the *current class*
                // Assuming 'uniqueNames' is already populated by 'populateDatalists2' for the current class
                setUpDropdown2('nameQueue', uniqueNames, "Select Your Name"); // Use uniqueNames for current class
                nameQueueDropdown.value = 'Select Your Name';
                nameQueueDropdown.removeAttribute('disabled');
                toggleAddToQueueButton();
            }
        });

        // Event listener for Bathroom Sign In form submission
        mainForm.addEventListener("submit", function() {
            clearInterval(timerInterval);
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signInButton").style.display = "none";
            document.getElementById("signOutButton").style.display = "none";
            courseDropdown.removeAttribute("disabled");
            mainForm.style.backgroundColor = "#4ade80"; // Green

            document.getElementById("alertDiv").classList.remove("hidden");
            document.getElementById("alertMessage").textContent = `${currentlySignedOutStudent} has been signed in successfully!`;
            setTimeout(() => document.getElementById("alertDiv").classList.add("hidden"), 5000);

            const signedInStudent = currentlySignedOutStudent; // Store for potential queue advancement
            currentlySignedOutStudent = null;

            if (queue.length > 0) {
                const nextPerson = queue.shift();
                // Ensure the main name dropdown is populated with names for the current class
                // This might require re-fetching or ensuring 'uniqueNames' is correctly scoped/updated
                populateDatalists2(allNames, courseDropdown.value); // Re-filter names for current class
                nameDropdown.value = nextPerson; // Set next person
                nameDropdown.setAttribute("disabled", "disabled"); // Disable main name dropdown
                courseDropdown.setAttribute("disabled", "disabled"); // Keep course disabled

                updateMessage(`${nextPerson} can now sign out.`);
                updateQueueDisplay();
                nameSelected(); // This will show the signOutButton for the nextPerson

                studentOutName.textContent = nextPerson; // This might be redundant if header is set
                studentOutHeader.textContent = `${nextPerson} IS NEXT`;
                studentOutHeader.style.backgroundColor = "#60a5fa"; // Blue for "IS NEXT"

                showQueueView();
            } else {
                // Reset name dropdown to allow selection for the current class
                populateDatalists2(allNames, courseDropdown.value); // Re-filter names for current class
                nameDropdown.value = 'Select Your Name';
                nameDropdown.removeAttribute("disabled");
                courseDropdown.removeAttribute("disabled"); // Allow class change

                document.getElementById("signOutButton").style.display = "none";
                updateMessage('The queue is empty. No one is currently signed out.');
                studentOutHeader.textContent = "PASS IS AVAILABLE";
                studentOutHeader.style.backgroundColor = "#4ade80"; // Green
                studentOutName.textContent = '';

                // Disable queue name dropdown as no one is out and queue is empty
                nameQueueDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Select Your Name"); // Clear and disable

                showLateSignInView();
            }
            toggleAddToQueueButton();
            updateToggleButtonVisibility();
        });

        // Event listener for Late Sign In form submission
        lateSignInForm.addEventListener('submit', function(event) {
            const selectedLateName = lateNameDropdown.value;

            if (selectedLateName === 'Select Your Name' || selectedLateName.trim() === '') {
                event.preventDefault();
                document.getElementById("alertDiv").classList.remove("hidden");
                document.getElementById("alertDiv").classList.add("bg-red-100", "border-red-400", "text-red-700");
                document.getElementById("alertDiv").classList.remove("bg-green-100", "border-green-400", "text-green-700");
                document.getElementById("alertMessage").textContent = `Please select a valid name to sign in late.`;
                setTimeout(() => {
                    document.getElementById("alertDiv").classList.add("hidden");
                    document.getElementById("alertDiv").classList.remove("bg-red-100", "border-red-400", "text-red-700");
                    document.getElementById("alertDiv").classList.add("bg-green-100", "border-green-400", "text-green-700");
                }, 5000);
            } else {
                const nameOnly2 = selectedLateName.includes("(") ? selectedLateName.substring(0, selectedLateName.indexOf("(")-1) : selectedLateName;
                document.getElementById("nameHolder2").value = nameOnly2;
                document.getElementById("classHolder").value = courseDropdown.value || "N/A"; // Ensure class is submitted

                document.getElementById("alertDiv").classList.remove("hidden");
                document.getElementById("alertMessage").textContent = `${selectedLateName} has been signed in late successfully!`;
                setTimeout(() => document.getElementById("alertDiv").classList.add("hidden"), 5000);

                setTimeout(() => {
                    lateNameDropdown.value = 'Select Your Name';
                    document.getElementById("lateSignInSubmitBtn").classList.add("hidden");
                }, 100);
            }
        });

        function getNumberFromName(name) {
            const match = name.match(/\((\d+)\)$/);
            return match ? parseInt(match[1]) : Infinity;
        }

        function updateMessage(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-text').classList.remove('hidden');
        }

        function updateQueueDisplay() {
            const queueList = document.getElementById('queue-list');
            const removeFromQueueButton = document.getElementById('remove-from-queue');

            queueList.innerHTML = '';
            selectedName = null;
            removeFromQueueButton.classList.add('hidden');

            if (queue.length === 0) {
                queueList.style.display = 'none';
                if (!currentlySignedOutStudent) {
                   updateMessage('The queue is currently empty. Add your name!');
                } else {
                   updateMessage('No one else is in queue. Select your name below to add.');
                }
            } else {
                queueList.style.display = 'block';
                updateMessage('Select a name to remove, or add another.');
                queue.sort((a, b) => getNumberFromName(a) - getNumberFromName(b));
                queue.forEach((person) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${person}`;
                    listItem.addEventListener('click', () => {
                        Array.from(queueList.children).forEach(item => {
                            item.classList.remove('bg-yellow-200-selected');
                        });
                        selectedName = person;
                        listItem.classList.add('bg-yellow-200-selected');
                        removeFromQueueButton.classList.remove('hidden');
                    });
                    queueList.appendChild(listItem);
                });
            }
            toggleAddToQueueButton();
            updateToggleButtonVisibility();
        }

        function toggleAddToQueueButton() {
            const addToQueueButton = document.getElementById('add-to-queue');
            const selectedQueueName = nameQueueDropdown.value;
            if (selectedQueueName === 'Select Your Name' || selectedQueueName.trim() === '' || !currentlySignedOutStudent) {
                addToQueueButton.classList.add('hidden');
            } else {
                addToQueueButton.classList.remove('hidden');
            }
        }

        nameQueueDropdown.addEventListener('change', toggleAddToQueueButton);

        document.getElementById('add-to-queue').addEventListener('click', () => {
            const name = nameQueueDropdown.value.trim();

            if (name === 'Select Your Name' || name === '') {
                updateMessage('Please select your name to add to the queue.');
            } else if (queue.includes(name)) {
                updateMessage('You are already in the queue.');
            } else if (currentlySignedOutStudent && name === currentlySignedOutStudent) {
                updateMessage(`${name} is currently signed out and cannot be added to the queue.`);
            } else if (!currentlySignedOutStudent) {
                updateMessage('Cannot add to queue as no one is currently signed out.');
            }
            else {
                queue.push(name);
                updateMessage(`${name} has been added to the queue.`);
                updateQueueDisplay();
                nameQueueDropdown.value = 'Select Your Name';
                toggleAddToQueueButton();
                if (!currentlySignedOutStudent) {
                    showQueueView();
                }
            }
            updateToggleButtonVisibility();
        });

        document.getElementById('remove-from-queue').addEventListener('click', () => {
            if (queue.length === 0) {
                updateMessage('The queue is already empty.');
            } else if (!selectedName) {
                updateMessage('Please select a name from the list to remove.');
            } else {
                const index = queue.indexOf(selectedName);
                if (index > -1) {
                    queue.splice(index, 1);
                    updateMessage(`Removed ${selectedName} from the queue.`);
                    updateQueueDisplay();
                } else {
                    updateMessage('Error: Name not found in queue.');
                }
                if (queue.length === 0 && !currentlySignedOutStudent) {
                    showLateSignInView();
                }
            }
            updateToggleButtonVisibility();
        });

        const url = "https://script.google.com/macros/s/AKfycbzIalB21jM1-vuBfJTpRjtwMc1jJYe0XL5SqCozJCzyNrpd6SBF0Mh_RXITRY5yC-Po/exec";
        document.getElementById('form').action = url;
        document.getElementById('lateSignInForm').action = url;

        function fetchClassData() {
            console.log('[DEBUG] fetchClassData started. User email:', signedInUserEmail);
            if (!signedInUserEmail) {
                console.error("[DEBUG] User email not available for fetching class data. Please sign in.");
                setUpDropdown('courseDropdown', [], "Sign in to load classes");
                courseDropdown.setAttribute("disabled", "disabled");
                return;
            }
            fetch(`${url}?header=Class&userEmail=${encodeURIComponent(signedInUserEmail)}`)
                .then((response) => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(({ data }) => {
                    console.log('[DEBUG] Class data received:', data);
                    classes = data;
                    populateDatalists("classes", data); // Populates courseDropdown
                    courseDropdown.removeAttribute("disabled");
                    courseDropdown.value = ""; // Set default
                })
                .catch((error) => {
                    console.error('[DEBUG] Error fetching class data:', error);
                    setUpDropdown('courseDropdown', [], "Error loading classes");
                });
        }

       function fetchAllNames() {
            console.log('[DEBUG] fetchAllNames started. User email:', signedInUserEmail);
            if (!signedInUserEmail) {
                console.error("[DEBUG] User email not available for fetching all names. Please sign in.");
                setUpDropdown2('lateNameDropdown', [], "Sign in to load names");
                lateNameDropdown.setAttribute("disabled", "disabled");
                return;
            }
            fetch(`${url}?action=getAllData&userEmail=${encodeURIComponent(signedInUserEmail)}`)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log('[DEBUG] All names data received:', data);
                    if (Array.isArray(data)) {
                        allNames = data; // Store the raw data which should be [{Name: "...", Class: "..."}, ...]
                        const allUniqueStudentNames = new Set();
                        // allUniqueStudentNames.add("Select Your Name"); // Default option added by setUpDropdown2
                        data.forEach(item => {
                            if (item && item.Name) {
                                allUniqueStudentNames.add(item.Name);
                            }
                        });
                        // This uniqueNames is for the LATE SIGN IN dropdown, should contain ALL names for the teacher.
                        const uniqueNamesForLateSignIn = Array.from(allUniqueStudentNames);
                        setUpDropdown2('lateNameDropdown', uniqueNamesForLateSignIn, "Select Your Name");
                        lateNameDropdown.removeAttribute("disabled"); // Enable after loading
                    } else {
                        console.error('[DEBUG] Error: fetchAllNames received non-array data:', data);
                        allNames = [];
                        setUpDropdown2('lateNameDropdown', [], "Error loading names");
                        lateNameDropdown.setAttribute("disabled", "disabled");
                    }
                })
                .catch(error => {
                    console.error('[DEBUG] Error fetching all names:', error);
                    setUpDropdown2('lateNameDropdown', [], "Error loading names");
                    lateNameDropdown.setAttribute("disabled", "disabled");
                });
        }


        const populateDatalists = (id, arr) => { // id is "classes", arr is class data
            console.log('[DEBUG] populateDatalists (for courses) called with:', id, arr);
            const uniqueItems = new Set();
            // uniqueItems.add("Select Class"); // Default option added by setUpDropdown
            for (const item of arr) { // arr is like ["Math", "Science", "Math"]
                uniqueItems.add(item);
            }
            uniqueCourses = Array.from(uniqueItems); // ["Math", "Science"]
            setUpDropdown('courseDropdown', uniqueCourses, "Select Class");
            console.log('[DEBUG] uniqueCourses populated:', uniqueCourses);
        };

        const populateDatalists2 = (allStudentData, courseName) => { // allStudentData is allNames, courseName is selected course
            console.log('[DEBUG] populateDatalists2 (for names in class) called with course:', courseName);
            const namesForSelectedClass = new Set();
            // namesForSelectedClass.add("Select Your Name"); // Default option added by setUpDropdown2

            // Filter allNames to get students only in the selected courseName
            allStudentData.forEach(student => {
                // Assuming student object has 'Name' and 'Class' properties
                if (student && student.Class === courseName && student.Name) {
                    namesForSelectedClass.add(student.Name);
                }
            });
            uniqueNames = Array.from(namesForSelectedClass); // This 'uniqueNames' is for the main form & queue for the selected class
            setUpDropdown2('nameDropdown', uniqueNames, "Select Your Name");
            // Only update queue dropdown if someone is signed out, otherwise it should be disabled.
            if (currentlySignedOutStudent) {
                 setUpDropdown2('nameQueue', uniqueNames, "Select Your Name");
            } else {
                 setUpDropdown2('nameQueue', [], "Select Your Name"); // Keep it empty or with default
                 nameQueueDropdown.setAttribute("disabled", "disabled");
            }
            console.log('[DEBUG] Names for class', courseName, ':', uniqueNames);
        };


        function removeOptions(selectElement) {
            if (!selectElement) return;
            while (selectElement.options.length > 0) {
                selectElement.remove(0);
            }
        }

        function courseChanged(){
            console.log('[DEBUG] courseChanged. Selected course:', courseDropdown.value);
            const selectedCourse = courseDropdown.value;
            document.getElementById("signOutButton").style.display = "none"; // Hide initially
            document.getElementById("signInButton").style.display = "none"; // Hide initially

            if (selectedCourse && selectedCourse !== "Select Class" && selectedCourse !== "") {
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameDropdown', [], "Loading names...");
                // Queue dropdown should only be populated/enabled if someone is signed out
                if (currentlySignedOutStudent) {
                    nameQueueDropdown.setAttribute("disabled", "disabled");
                    setUpDropdown2('nameQueue', [], "Loading names...");
                } else {
                    nameQueueDropdown.setAttribute("disabled", "disabled");
                    setUpDropdown2('nameQueue', [], "Select Your Name"); // Keep disabled if no one out
                }
                // Late name dropdown is independent of class selection for its list, but its selection enables submit.
                // It's populated by fetchAllNames.
                // lateNameDropdown.removeAttribute("disabled"); // Already handled by fetchAllNames

                // Populate names for the selected class
                populateDatalists2(allNames, selectedCourse); // This will update nameDropdown and nameQueueDropdown
                nameDropdown.removeAttribute("disabled");
                if(currentlySignedOutStudent) nameQueueDropdown.removeAttribute("disabled");

            } else { // "Select Class" or empty is chosen
                setUpDropdown2('nameDropdown', [], "Select Your Name");
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Select Your Name");
                nameQueueDropdown.setAttribute("disabled", "disabled");
                // Late name dropdown should remain enabled and populated with all names.
                // setUpDropdown2('lateNameDropdown', [], "Select Your Name"); // Don't reset late names
                // lateNameDropdown.setAttribute("disabled", "disabled"); // Don't disable late names
            }
            nameSelected(); // Update button visibility based on name selection
            updateToggleButtonVisibility();
        }

        // No updateNameDropdown function as its logic is now in courseChanged -> populateDatalists2

        function nameSelected(){
            const selectedMainName = nameDropdown.value;
            console.log('[DEBUG] nameSelected. Selected name:', selectedMainName, 'Timer interval:', timerInterval, 'Currently signed out:', currentlySignedOutStudent);

            if(selectedMainName === "Select Your Name" || selectedMainName.trim() === '' || timerInterval !== null || (currentlySignedOutStudent && selectedMainName === currentlySignedOutStudent) ){
                document.getElementById("signOutButton").style.display = "none";
            } else {
                 // Only show sign out if no one is out OR if the selected person is the one who is "NEXT"
                if (!currentlySignedOutStudent || (studentOutHeader.textContent.includes("IS NEXT") && selectedMainName === studentOutName.textContent)) {
                    document.getElementById("signOutButton").style.display = "block";
                } else {
                    document.getElementById("signOutButton").style.display = "none";
                }
            }
            // Sign In button is only visible if timerInterval is active (someone is physically out)
            document.getElementById("signInButton").style.display = timerInterval !== null ? "block" : "none";
            updateToggleButtonVisibility();
        }

        function lateNameSelected(){
            const selectedLateName = lateNameDropdown.value;
            console.log('[DEBUG] lateNameSelected. Selected late name:', selectedLateName);
            if (selectedLateName !== "Select Your Name" && selectedLateName.trim() !== '') {
                document.getElementById("lateSignInSubmitBtn").classList.remove("hidden");
                document.getElementById("classHolder").value = courseDropdown.value || "N/A"; // Get current class or N/A
            } else {
                document.getElementById("lateSignInSubmitBtn").classList.add("hidden");
            }
        }

        function setUpDropdown(dropdownId, arr, defaultText = "Select Class") {
            let selectElement = document.getElementById(dropdownId);
            if (!selectElement) {
                console.error(`[DEBUG] setUpDropdown: Element with ID '${dropdownId}' not found.`);
                return;
            }
            removeOptions(selectElement);
            let defaultOption = new Option(defaultText, "");
            if (defaultText.includes("Loading...") || defaultText.includes("Error")) {
                defaultOption.disabled = true; // Make loading/error options not selectable
            }
            selectElement.add(defaultOption);
            arr.forEach(str => {
                selectElement.add(new Option(str, str));
            });
            selectElement.disabled = (arr.length === 0 && (defaultText.includes("Loading...") || defaultText.includes("Error loading classes") || defaultText.includes("Sign in to load")));
        }

        function setUpDropdown2(dropdownId, arr, defaultText = "Select Your Name") {
            let selectElement = document.getElementById(dropdownId);
             if (!selectElement) {
                console.error(`[DEBUG] setUpDropdown2: Element with ID '${dropdownId}' not found.`);
                return;
            }
            removeOptions(selectElement);
            let defaultOption = new Option(defaultText, "Select Your Name");
             if (defaultText.includes("Loading...") || defaultText.includes("Error")) {
                defaultOption.disabled = true;
            }
            selectElement.add(defaultOption);
            arr.forEach(str => {
                if (str !== "Select Your Name") {
                    selectElement.add(new Option(str, str));
                }
            });
             // Disabling logic is handled by calling functions based on context
        }

        function showQueueView() {
            queueArea.classList.remove('hidden');
            lateSignInView.classList.add('hidden');
            queueViewBtn.classList.replace('bg-yellow-200', 'bg-purple-400');
            queueViewBtn.classList.replace('text-gray-800', 'text-white');
            lateSignInViewBtn.classList.replace('bg-purple-400', 'bg-yellow-200');
            lateSignInViewBtn.classList.replace('text-white', 'text-gray-800');
            console.log('[DEBUG] Switched to Queue View.');
        }

        function showLateSignInView() {
            queueArea.classList.add('hidden');
            lateSignInView.classList.remove('hidden');
            lateSignInViewBtn.classList.replace('bg-purple-400', 'bg-yellow-200');
            lateSignInViewBtn.classList.replace('text-white', 'text-gray-800');
            queueViewBtn.classList.replace('bg-yellow-200', 'bg-purple-400');
            queueViewBtn.classList.replace('text-gray-800', 'text-white');
            console.log('[DEBUG] Switched to Late Sign In View.');
        }

        function updateToggleButtonVisibility() {
            // This function now mainly ensures styles are correct based on current view.
            // Actual hiding/showing of queueArea/lateSignInView is done by showQueueView/showLateSignInView.
            console.log('[DEBUG] updateToggleButtonVisibility called.');
        }

        queueViewBtn.addEventListener('click', showQueueView);
        lateSignInViewBtn.addEventListener('click', showLateSignInView);
    </script>
</body>
</html>
