<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Pass System by Jander</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
    >
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script type="text/javascript">
    window.onbeforeunload = function() {
        // This will prompt the user before leaving the page.
        // It's generally good practice to inform users if they are about to lose unsaved data.
        // You might want to refine this to only trigger if a timer is running.
        if (timerInterval !== null) {
            return "You have a student signed out. Are you sure you want to leave?";
        }
        return null; // Don't show a prompt if no student is signed out
    }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1d1d; /* A lighter green for the page background */
        }
        form {
            font-size: 1.125rem; /* text-lg */
            transition: background-color 0.5s ease; /* Smooth transition for form color changes */
        }
        select {
            font-size: 1.125rem; /* text-lg for consistency with form text */
        }
        /* Removed focus:ring styles from select elements */
        select:focus {
            outline: none;
            border-color: #d1d5db; /* Revert to default border color on focus */
            box-shadow: none; /* Remove any box shadow on focus */
        }
        #queue-list li {
            cursor: pointer;
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            margin-bottom: 0.375rem;
        }
        #queue-list li:last-child {
            margin-bottom: 0;
        }
        #queue-list li:hover {
            background-color: #e2e8f0;
            color: #1a202c;
        }
        /* Added the specific class for selected item */
        #queue-list li.bg-yellow-200-selected {
            background-color: #0692e8;
            color: #2d3748;
        }
        /* The iframe is no longer functionally used for form submission but can remain hidden */
        iframe[name="iframe"] {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 0;
            height: 0;
            visibility: hidden;
        }
        /* Style for the large header */
        #studentOutHeader {
             font-size: 5rem; /* ~text-6xl or larger */
             line-height: 1.1;
             color: #030000; /* black */
        }
        
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen" id="body">

    <div id="signInPage" class="flex flex-col items-center justify-center min-h-screen w-full">
        <h1 class="text-4xl font-bold text-white mb-8">ðŸ’© Welcome to AHS "Bathroom" Pass ðŸ’©</h1>
        <p class="text-gray-300 mb-6">Please sign in with your Google account to continue.</p>
        <div id="googleSignInButton"></div>
        <p class="text-red-500 mt-4 hidden" id="signInError">Sign-in failed. Please try again.</p>
    </div>

    <div id="appContent" class="hidden flex flex-col items-center p-4 min-h-screen w-full">
        <div id="profileMenuContainer" class="absolute top-4 right-4 z-50 hidden">
            <img id="profilePicture" src="" alt="Profile" class="w-10 h-10 rounded-full cursor-pointer border-2 border-red-500 hover:border-blue-500 transition-all duration-200">
            
            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl py-2 text-gray-800 border-2 border-red-500">
                <div class="px-4 py-2 text-sm font-medium text-center" id="dropdownUserName"></div>
                <div class="px-4 pb-2 text-xs text-center text-gray-600" id="dropdownUserEmail"></div>
                <hr class="my-1">
                <button id="dropdownSignOutButton" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">
                    Sign Out of Google
                </button>
            </div>
        </div>
        <h1 id="studentOutHeader" class="font-bold text-center mb-6 p-2 w-full rounded-lg flex items-center justify-center whitespace-nowrap overflow-hidden text-overflow-ellipsis">
            <span id="emojiLeft" class="mr-2"></span><span id="studentOutName"></span> <span id="headerStatus">PASS IS AVAILABLE</span><span id="emojiRight" class="ml-2"></span>
        </h1>

        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative text-sm hidden mb-2 w-2/3" id="alertDiv" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline" id="alertMessage">You have been signed in successfully!</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('alertDiv').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm hidden mb-2 w-2/3" id="errorAlertDiv" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorAlertMessage"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('errorAlertDiv').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div id="mainContentContainer" class="flex flex-col lg:flex-row items-start lg:items-stretch justify-center w-full max-w-6xl gap-6">

            <form
                id="form"
                class="rounded-lg shadow-xl p-6 w-full lg:w-2/3 space-y-4 flex-shrink-0"
                style="background-color: #4ade80;" /* Initial background for the form (Green) */
            >
                <h2 id="passLabel" class="text-2xl font-bold text-gray-800 mb-6 text-center">Bathroom Pass</h2>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="class">Class:</label>
                    <select id="courseDropdown" onchange="courseChanged()" name="Class"
                        class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="name">Name:</label>
                    <select id="nameDropdown" onchange="nameSelected()" class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                    <select id="emojiDropdown" class="block w-fit p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none ml-4 hidden">
                        </select>
                </div>
                
                <div class="flex justify-center space-x-3 mt-4">
                    <button id="signOutButton" type="button" 
                        class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign Out
                    </button>
                    <button id="signInButton" type="submit"
                        class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign In
                    </button>
                </div>

                <p class="text-center text-lg font-medium text-gray-800 mt-4">Time: <span id="minutes" class="font-bold">0</span>:<span id="seconds" class="font-bold">00</span></p>
            </form>

            <div id="rightSideFormsContainer" class="w-full lg:w-1/3 flex flex-col rounded-lg shadow-xl">
                <div class="flex w-full justify-center">
                    <button id="queueViewBtn" class="px-6 py-3 w-1/2 rounded-tl-lg rounded-tr-none font-semibold text-white bg-purple-400 hover:bg-purple-500 focus:outline-none transition-colors duration-200">
                        View Queue
                    </button>
                    <button id="lateSignInViewBtn" class="px-6 py-3 w-1/2 rounded-tl-none rounded-tr-lg font-semibold text-gray-800 bg-yellow-200 hover:bg-yellow-300 focus:outline-none transition-colors duration-200">
                        Late Sign In
                    </button>
                </div>

                <div id="queueArea" class="bg-purple-400 p-6 w-full text-center flex-shrink-0 rounded-b-lg flex-grow hidden">
                    <h2 class="text-2xl font-bold text-black-900 text-center mb-5">Queue for Bathroom</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="nameQueue">Name:</label>
                        <select id="nameQueue"
                            class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                        </select>
                    </div>
                    <button id="add-to-queue"
                        class="mt-4 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none transition-colors duration-200 text-base hidden">
                        Add to Queue
                    </button>

                    <div id="message-area" class="bg-blue-50 border border-blue-200 rounded-md p-4 text-blue-800 mt-4">
                        <p id="message-text" class="hidden text-center text-base font-medium">Please select your name and click 'Add to Queue'.</p>
                        <ol id="queue-list" class="list-decimal list-inside mt-3 text-left text-gray-800 text-base">
                        </ol>
                        <button id="remove-from-queue"
                            class="mt-4 px-5 py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none transition-colors duration-200 text-base hidden">
                            Remove Selected from Queue
                        </button>
                    </div>
                </div>

                <div id="lateSignInView" class="flex flex-col items-center justify-start w-full p-6 rounded-b-lg bg-yellow-200 flex-grow">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Late Sign In</h2>
                    <form id="lateSignInForm" class="w-full space-y-4"> 
                        <div class="flex flex-col sm:flex-row items-start sm:items-center">
                            <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="lateNameDropdown">Name:</label>
                            <select id="lateNameDropdown"  onchange="lateNameSelected()"
                                class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                                
                            </select>
                        </div>
                        <div class="flex justify-center mt-6">
                            <button type="submit" id="lateSignInSubmitBtn" class=" hidden px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base">
                                Sign In Late
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
        </div>

    </div>

    <iframe name="iframe"></iframe>

    <script>
        // --- Google Sign-In Integration ---
        let userEmail = ''; // Global variable to store the signed-in user's email
        let userName = ''; // Global variable to store the signed-in user's name
        let userProfilePic = ''; // Global variable to store the signed-in user's profile picture URL
        let idToken = ''; // Global variable to store the ID token

        // Helper function to decode JWT token
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Initialize Google Sign-In
        function initGoogleSignIn() {
            google.accounts.id.initialize({
                client_id: '793583956284-3bnmlmr42c18s79mfj8fkcrci3a197j3.apps.googleusercontent.com', // Your Google Client ID
                callback: onSignIn // Function to call on successful sign-in
            });

            // Render the Google Sign-In button
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                { 
                    theme: 'dark', 
                    size: 'large', 
                    text: 'signin_with', 
                    shape: 'rectangular', 
                    logo_alignment: 'left' 
                } // customization attributes
            );
        }

        // Callback function for successful sign-in (GSI CredentialResponse)
        function onSignIn(response) {
            console.log('User signed in successfully with GSI!');
            const profile = decodeJwtResponse(response.credential);
            
            console.log('ID: ' + profile.sub); // Google User ID
            console.log('Name: ' + profile.name);
            console.log('Image URL: ' + profile.picture);
            console.log('Email: ' + profile.email);
            
            userEmail = profile.email; // Store the user's email
            userName = profile.name; // Store the user's name
            userProfilePic = profile.picture; // Store the user's profile picture URL
            idToken = response.credential; // Store the ID token
            document.getElementById("passLabel").textContent="Bathroom Pass for " + userName +"'s Class";

            // Update profile picture and details in the dropdown
            document.getElementById('profilePicture').src = userProfilePic;
            document.getElementById('dropdownUserName').textContent = userName;
            document.getElementById('dropdownUserEmail').textContent = userEmail;

            // Hide sign-in page and show app content
            document.getElementById('signInPage').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('body').classList.remove('justify-center'); // Remove center alignment for app content
            document.getElementById('profileMenuContainer').classList.remove('hidden'); // Show the profile icon

            // Re-initialize the app content after sign-in
            initializeBathroomPassApp();
        }

        // Handle sign-out
        function signOut() {
            google.accounts.id.disableAutoSelect(); // Disables auto-selection for future visits
            console.log('User signed out.');
            userEmail = ''; // Clear the user's email on sign out
            userName = ''; // Clear the user's name on sign out
            userProfilePic = ''; // Clear the user's profile picture on sign out
            idToken = ''; // Clear the ID token

            // Hide app content and show sign-in page
            document.getElementById('appContent').classList.add('hidden');
            document.getElementById('signInPage').classList.remove('hidden');
            document.getElementById('body').classList.add('justify-center'); // Re-center sign-in page
            document.getElementById('profileMenuContainer').classList.add('hidden'); // Hide the profile icon
            document.getElementById('profileDropdown').classList.add('hidden'); // Ensure dropdown is hidden

            // Reset app state if necessary (e.g., clear timers, queue)
            resetBathroomPassAppState();
        }

        // --- Bathroom Pass Application Logic (from original code) ---
        const mainForm = document.getElementById('form');
        const nameDropdown = document.getElementById('nameDropdown');
        const courseDropdown = document.getElementById('courseDropdown');
        const emojiDropdown = document.getElementById('emojiDropdown'); // New emoji dropdown
        const nameQueueDropdown = document.getElementById('nameQueue');
        const studentOutHeader = document.getElementById('studentOutHeader');
        const studentOutName = document.getElementById('studentOutName');
        const emojiLeft = document.getElementById('emojiLeft'); // New emoji span
        const emojiRight = document.getElementById('emojiRight'); // New emoji span
        const headerStatus = document.getElementById('headerStatus'); // New header status span

        const queueArea = document.getElementById('queueArea'); // Bathroom Pass Queue
        const lateSignInView = document.getElementById('lateSignInView'); // Late Sign In Form
        const queueViewBtn = document.getElementById('queueViewBtn'); // New button for Queue
        const lateSignInViewBtn = document.getElementById('lateSignInViewBtn'); // Existing button, renamed for clarity

        const lateNameDropdown = document.getElementById('lateNameDropdown');
        const lateSignInForm = document.getElementById('lateSignInForm'); // Get the late form

        let seconds = 0;
        let minutes = 0;
        let timerInterval = null;
        let queue = [];
        let selectedName = null;
        let currentlySignedOutStudent = null;
        
        // List of emojis for the dropdown
        const emojiList = ['ðŸš½', 'ðŸš¿', 'ðŸ›', 'ðŸ§»', 'ðŸ§¼', 'ðŸ§´', 'ðŸ’¦', 'ðŸ’§', 'ðŸƒâ€â™‚ï¸', 'ðŸ’¨', 'ðŸ¤«', 'ðŸš¶â€â™€ï¸', 'ðŸ˜…', 'âœ¨', 'ðŸš»', 'ðŸš¾'];

        function updateTimer() {
            seconds++;
            const TARDY_TIME = 5
            if (seconds >= 60) {
                minutes++;
                seconds = 0;
            }
            if (minutes >= TARDY_TIME) {
                mainForm.style.backgroundColor = "#ef4444"; // Red
                studentOutHeader.style.backgroundColor = "#ef4444";

            }
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = seconds < 10 ? "0" + seconds : seconds;
        }

        document.getElementById("signOutButton").addEventListener("click", function() {
            if (!timerInterval) {
                timerInterval = setInterval(updateTimer, 1000);
                this.style.display = "none";
                document.getElementById("signInButton").style.display = "block";
                nameDropdown.setAttribute("disabled", "disabled");
                courseDropdown.setAttribute("disabled", "disabled");
                emojiDropdown.setAttribute("disabled", "disabled"); // Disable emoji dropdown
                mainForm.style.backgroundColor = "#f6b26b"; // Orange

                const fullString = nameDropdown.value;
                const nameOnly = fullString.includes("(") ? fullString.substring(0, fullString.indexOf("(")-1) : fullString;
                // document.getElementById("nameHolder").value = nameOnly; // No longer using hidden input

                studentOutName.textContent = nameOnly; // Set student name
                headerStatus.textContent = "IS OUT"; // Set status text
                studentOutHeader.style.backgroundColor = "#f6b26b"; // Orange for "IS OUT"

                const selectedEmoji = emojiDropdown.value;
                if (selectedEmoji !== "No Emoji") {
                    emojiLeft.textContent = selectedEmoji;
                    emojiRight.textContent = selectedEmoji;
                } else {
                    emojiLeft.textContent = "";
                    emojiRight.textContent = "";
                }

                currentlySignedOutStudent = fullString;
                // Update message and show queue automatically
                updateQueueDisplay();
                showQueueView(); // Automatically switch to queue view
                updateToggleButtonVisibility(); // Update button visibility

                // nameQueueDropdown should already be updated by populateNameDropdownsForCourse on class change
                // We just need to ensure it's enabled and reset its value
                nameQueueDropdown.value = 'Select Your Name';
                nameQueueDropdown.removeAttribute('disabled');
                toggleAddToQueueButton();
            }
        });

        // Event listener for Bathroom Sign In (main form submission using fetch)
        mainForm.addEventListener("submit", function(event) {
            event.preventDefault(); // Prevent default form submission

            const fullString = nameDropdown.value;
            const nameOnly = fullString.includes("(") ? fullString.substring(0, fullString.indexOf("(")-1) : fullString;
            const classValue = courseDropdown.value;
            const timeOutSeconds = (minutes * 60) + seconds;

            const payload = {
                action: 'logSignIn', // New action for Apps Script
                Seconds: timeOutSeconds,
                Name: nameOnly,
                Class: classValue,
                idToken: idToken // Include the ID token for authentication
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    seconds = 0;
                    minutes = 0;
                    document.getElementById("minutes").textContent = minutes;
                    document.getElementById("seconds").textContent = "00";
                    document.getElementById("signInButton").style.display = "none";
                    document.getElementById("signOutButton").style.display = "none";
                    courseDropdown.removeAttribute("disabled");
                    emojiDropdown.removeAttribute("disabled"); // Enable emoji dropdown
                    mainForm.style.backgroundColor = "#4ade80"; // Green

                    // Show success alert
                    document.getElementById("alertDiv").classList.remove("hidden");
                    document.getElementById("alertDiv").classList.remove("bg-red-100", "border-red-400", "text-red-700"); // Ensure it's green
                    document.getElementById("alertDiv").classList.add("bg-green-100", "border-green-400", "text-green-700");
                    document.getElementById("alertMessage").textContent = `${currentlySignedOutStudent} has been signed in successfully!`;
                    setTimeout(() => document.getElementById("alertDiv").classList.add('hidden'), 5000);

                    currentlySignedOutStudent = null;
                    
                    if (queue.length > 0) {
                        const nextPerson = queue.shift();
                        nameDropdown.value = nextPerson;
                        nameDropdown.setAttribute("disabled", "disabled");
                        updateMessage(`${nextPerson} can now sign out.`);
                        updateQueueDisplay();
                        nameSelected();

                        studentOutName.textContent = nextPerson; // Set student name
                        headerStatus.textContent = "IS NEXT"; // Set status text
                        studentOutHeader.style.backgroundColor = "#4ade80"; // Green for "IS NEXT"
                        
                        emojiLeft.textContent = ""; // Clear emojis
                        emojiRight.textContent = ""; // Clear emojis
                        emojiDropdown.value = "No Emoji"; // Reset emoji dropdown

                        showQueueView(); // Keep queue view active
                    } else {
                        nameDropdown.value = 'Select Your Name';
                        nameDropdown.removeAttribute("disabled");
                        document.getElementById("signOutButton").style.display = "none";
                        updateMessage('The queue is empty. No one is currently signed out.');
                        // Update header to "PASS IS AVAILABLE"
                        studentOutName.textContent = ''; // Clear student name
                        headerStatus.textContent = "PASS IS AVAILABLE"; // Set status text
                        studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass
                        
                        emojiLeft.textContent = ""; // Clear emojis
                        emojiRight.textContent = ""; // Clear emojis
                        emojiDropdown.value = "No Emoji"; // Reset emoji dropdown

                        nameQueueDropdown.setAttribute("disabled", "disabled"); //Disable the queue dropdown
                        // Explicitly hide queue buttons when pass is available
                        document.getElementById('add-to-queue').classList.add('hidden');
                        document.getElementById('remove-from-queue').classList.add('hidden');

                        showLateSignInView(); // Switch back to late sign-in view
                    }
                    toggleAddToQueueButton();
                    updateToggleButtonVisibility(); // Update button visibility

                } else {
                    showErrorAlert(`Error signing in: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error submitting main sign in:', error);
                showErrorAlert("Failed to submit sign-in. This might be due to network issues or because you need to authorize the 'Data Entry' app. Please ensure you have authorized the app and try again.");
            });
        });

        // Function to display error alerts
        function showErrorAlert(message) {
            const errorDiv = document.getElementById("errorAlertDiv");
            const errorMessageSpan = document.getElementById("errorAlertMessage");
            errorMessageSpan.textContent = message;
            errorDiv.classList.remove("hidden");
            // Ensure it's red and visible
            errorDiv.classList.remove("bg-green-100", "border-green-400", "text-green-700");
            errorDiv.classList.add("bg-red-100", "border-red-400", "text-red-700");
            setTimeout(() => errorDiv.classList.add('hidden'), 10000); // Keep error longer
        }

        // Event listener for Late Sign In form submission
        lateSignInForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission via iframe
            const selectedLateName = lateNameDropdown.value;

            if (selectedLateName === 'Select Your Name' || selectedLateName.trim() === '') {
                showErrorAlert(`Please select a valid name to sign in late.`);
                return; // Stop execution
            }

            const nameOnly2 = selectedLateName.includes("(") ? selectedLateName.substring(0, selectedLateName.indexOf("(")-1) : selectedLateName;
            const classValue = courseDropdown.value; // Get the selected class

            // Prepare data for POST request
            const payload = {
                action: 'logLateSignIn', // New action for Apps Script to handle
                Seconds: 'Late Sign In', // Or actual seconds if you want to track it
                Name: nameOnly2,
                Class: classValue,
                idToken: idToken // Include the ID token for authentication
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    document.getElementById("alertDiv").classList.remove("hidden");
                    document.getElementById("alertDiv").classList.remove("bg-red-100", "border-red-400", "text-red-700"); // Ensure it's green
                    document.getElementById("alertDiv").classList.add("bg-green-100", "border-green-400", "text-green-700");
                    document.getElementById("alertMessage").textContent = `${selectedLateName} has been signed in late successfully!`;
                    setTimeout(() => document.getElementById("alertDiv").classList.add("hidden"), 5000);

                    lateNameDropdown.value = 'Select Your Name';
                    document.getElementById("lateSignInSubmitBtn").classList.add("hidden");
                } else {
                    showErrorAlert(`Error signing in late: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error submitting late sign in:', error);
                showErrorAlert("Failed to submit late sign-in. This might be due to network issues or because you need to authorize the 'Data Entry' app. Please ensure you have authorized the app and try again.");
            });
        });


        function getNumberFromName(name) {
            const match = name.match(/\((\d+)\)$/);
            return match ? parseInt(match[1]) : Infinity;
        }

        function updateMessage(message) {
            document.getElementById('message-text').textContent = message;
        }

        function updateQueueDisplay() {
            const queueList = document.getElementById('queue-list');
            const removeFromQueueButton = document.getElementById('remove-from-queue');

            queueList.innerHTML = '';
            selectedName = null;
            removeFromQueueButton.classList.add('hidden');

            if (queue.length === 0) {
                queueList.style.display = 'none';
                if (!currentlySignedOutStudent) {
                   updateMessage('The queue is currently empty. Add your name!');
                } else {
                   updateMessage('No one else is in queue. Select your name below to add.');
                }
            } else {
                queueList.style.display = 'block';
                updateMessage('Please select a name from the list to remove, or add another.');

                queue.sort((a, b) => getNumberFromName(a) - getNumberFromName(b));

                queue.forEach((person) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${person}`;
                    listItem.addEventListener('click', () => {
                        Array.from(queueList.children).forEach(item => {
                            item.classList.remove('bg-yellow-200-selected');
                        });
                        selectedName = person;
                        listItem.classList.add('bg-yellow-200-selected');
                        removeFromQueueButton.classList.remove('hidden');
                    });
                    queueList.appendChild(listItem);
                });
            }
            toggleAddToQueueButton();
            updateToggleButtonVisibility(); // Update button visibility
        }

        function toggleAddToQueueButton() {
            const addToQueueButton = document.getElementById('add-to-queue');
            if (nameQueueDropdown.value === 'Select Your Name' || nameQueueDropdown.value.trim() === '' || nameQueueDropdown.disabled) {
                addToQueueButton.classList.add('hidden');
            } else {
                addToQueueButton.classList.remove('hidden');
            }
        }

        nameQueueDropdown.addEventListener('change', toggleAddToQueueButton);

        document.getElementById('add-to-queue').addEventListener('click', () => {
            const name = nameQueueDropdown.value.trim();

            if (name === 'Select Your Name' || name === '') {
                updateMessage('Please select your name to add to the queue.');
            } else if (queue.includes(name)) {
                updateMessage('You are already in the queue.');
            } else if (currentlySignedOutStudent && name === currentlySignedOutStudent) {
                updateMessage(`${name} is currently signed out and cannot be added to the queue.`);
            } else {
                queue.push(name);
                updateMessage(`${name} has been added to the queue.`);
                updateQueueDisplay();
                nameQueueDropdown.value = 'Select Your Name';
                toggleAddToQueueButton();
                // Ensure queue is visible if something is added and no one is out
                if (!currentlySignedOutStudent) {
                    showQueueView();
                }
            }
            updateToggleButtonVisibility(); // Update button visibility
        });

        document.getElementById('remove-from-queue').addEventListener('click', () => {
            if (queue.length === 0) {
                updateMessage('The queue is already empty.');
            } else if (!selectedName) {
                updateMessage('Please select a name from the list to remove.');
            } else {
                const index = queue.indexOf(selectedName);
                if (index > -1) {
                    queue.splice(index, 1);
                    updateMessage(`Removed ${selectedName} from the queue.`);
                    updateQueueDisplay();
                } else {
                    updateMessage('Error: Name not found in queue.');
                }
                if (queue.length === 0 && !currentlySignedOutStudent) {
                    showLateSignInView(); // Go back to late sign-in if queue is empty and no one is out
                }
            }
            updateToggleButtonVisibility(); // Update button visibility
        });

        // Function to initialize the bathroom pass app content
        function initializeBathroomPassApp() {
            const alertDiv = document.getElementById("alertDiv");
            if (alertDiv) {
                alertDiv.classList.add("hidden");
            }
            const errorAlertDiv = document.getElementById("errorAlertDiv");
            if (errorAlertDiv) {
                errorAlertDiv.classList.add("hidden");
            }

            // Set initial state for studentOutHeader
            studentOutName.textContent = ''; // Clear student name
            headerStatus.textContent = "PASS IS AVAILABLE"; // Set status text
            studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass
            emojiLeft.textContent = ""; // Clear emojis
            emojiRight.textContent = ""; // Clear emojis


            updateQueueDisplay();
            toggleAddToQueueButton();

            setUpDropdown('courseDropdown', [], "Loading...");
            courseDropdown.setAttribute("disabled", "disabled");

            // All name dropdowns initially disabled/empty
            setUpDropdown2('nameDropdown', [], "Select Your Name");
            nameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameQueue', [], "Select Your Name");
            nameQueueDropdown.setAttribute("disabled", "disabled");
            document.getElementById('add-to-queue').classList.add('hidden'); // Explicitly hide
            document.getElementById('remove-from-queue').classList.add('hidden'); // Explicitly hide


            setUpDropdown2('lateNameDropdown', [], "Select Your Name");
            lateNameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown('emojiDropdown', emojiList, "No Emoji"); // Populate emoji dropdown
            emojiDropdown.classList.add('hidden'); // Ensure hidden initially
            emojiDropdown.setAttribute("disabled", "disabled"); // Disable emoji dropdown initially
            emojiDropdown.value = "No Emoji"; // Ensure default is selected


            document.getElementById("signOutButton").style.display = "none";

            // Only fetch data if userEmail is available
            if (userEmail && idToken) { // Ensure idToken is also available
                // Fetch all names first, as other functions depend on it
                fetchAllNames().then(() => {
                    fetchClassData(); // Then fetch classes, which relies on allNames for unique classes
                });
            } else {
                console.warn("User email or ID token not available. Cannot fetch class/name data.");
                setUpDropdown('courseDropdown', [], "Sign in to load classes");
                setUpDropdown2('nameDropdown', [], "Sign in to load names");
                setUpDropdown2('nameQueue', [], "Sign in to load names");
                setUpDropdown2('lateNameDropdown', [], "Sign in to load names");
                setUpDropdown('emojiDropdown', [], "Sign in to load emojis");
                emojiDropdown.setAttribute("disabled", "disabled");
            }
            
            showLateSignInView(); // Set initial right-side view to Late Sign In
            updateToggleButtonVisibility(); // Initial button visibility update
        }

        // Function to reset the bathroom pass app state on sign-out
        function resetBathroomPassAppState() {
            clearInterval(timerInterval);
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            queue = [];
            selectedName = null;
            currentlySignedOutStudent = null;
            allNames = []; // Clear allNames on sign out
            uniqueNamesForCourse = []; // Clear unique names for current course

            // Reset UI elements
            document.getElementById("minutes").textContent = "0";
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signInButton").style.display = "none";
            document.getElementById("signOutButton").style.display = "none";
            // Do not re-enable course dropdown here; initializeBathroomPassApp will handle it on next sign-in
            mainForm.style.backgroundColor = "#4ade80"; // Green
            studentOutName.textContent = ''; // Clear student name
            headerStatus.textContent = "PASS IS AVAILABLE"; // Set status text
            studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass
            emojiLeft.textContent = ""; // Clear emojis
            emojiRight.textContent = ""; // Clear emojis
            
            // Clear dropdowns and disable them
            setUpDropdown('courseDropdown', [], "Select Class");
            courseDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameDropdown', [], "Select Your Name");
            nameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameQueue', [], "Select Your Name");
            nameQueueDropdown.setAttribute("disabled", "disabled");
            document.getElementById('add-to-queue').classList.add('hidden'); // Explicitly hide
            document.getElementById('remove-from-queue').classList.add('hidden'); // Explicitly hide


            setUpDropdown2('lateNameDropdown', [], "Select Your Name");
            lateNameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown('emojiDropdown', emojiList, "No Emoji"); // Reset emoji dropdown
            emojiDropdown.classList.add('hidden'); // Ensure hidden
            emojiDropdown.setAttribute("disabled", "disabled");

            // Hide queue and show late sign-in by default
            showLateSignInView();
            updateQueueDisplay(); // Clear queue display
        }


        const url = "https://script.google.com/macros/s/AKfycbzIalB21jM1-vuBfJTpRjtwMc1jJYe0XL5SqCozJCzyNrpd6SBF0Mh_RXITRY5yC-Po/exec"
        let classes = []; // This will now hold unique class names (derived from allNames)
        let uniqueCourses = [];
        let allNames = []; // Store all names data as objects: [{Class: "...", Name: "..."}, ...]
        let uniqueNamesForCourse = []; // Names specific to the currently selected course


        // This function now fetches all data for the teacher
        function fetchAllNames() {
            // Change to POST request to send ID token securely
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'getAllData', // Indicate the action for the Apps Script
                    userEmail: userEmail, // Send user email (for convenience, but backend should verify from token)
                    idToken: idToken // Send the ID token
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        allNames = data; // Store the structured data
                    } else {
                        console.error('Error: fetchAllNames received non-array data:', data);
                        allNames = []; // Reset to empty array to prevent further errors
                        setUpDropdown2('lateNameDropdown', [], "Error loading names");
                        document.getElementById('lateNameDropdown').setAttribute("disabled", "disabled");
                        showErrorAlert("Failed to load data. The server returned unexpected data. Please check Apps Script logs.");
                    }
                })
                .catch(error => {
                    console.error('Error fetching all names:', error);
                    setUpDropdown2('lateNameDropdown', [], "Error loading names");
                    document.getElementById('lateNameDropdown').setAttribute("disabled", "disabled");
                    showErrorAlert("Failed to load data. This might be due to network issues or because you need to authorize the 'Data Entry' app. Please ensure you have authorized the app and try refreshing the page.");
                });
        }

        // This function now populates course dropdown after allNames is fetched
        function fetchClassData() {
            if (allNames.length > 0) {
                const uniqueClassNames = new Set();
                allNames.forEach(item => {
                    if (item && item.Class) {
                        uniqueClassNames.add(item.Class);
                    }
                });
                uniqueCourses = Array.from(uniqueClassNames);
                setUpDropdown('courseDropdown', uniqueCourses);
                courseDropdown.removeAttribute("disabled");
                courseDropdown.value = ""; // Reset to default "Select Class"
            } else {
                setUpDropdown('courseDropdown', [], "No classes found or data error");
            }
        }


        function removeOptions(selectElement) {
            while (selectElement.options.length > 0) {
                selectElement.remove(0);
            }
        }

        // This function now filters from the 'allNames' array and populates all relevant name dropdowns
        const populateNameDropdownsForCourse = (selectedCourseName) => {
            const namesForCurrentCourse = new Set();
            namesForCurrentCourse.add("Select Your Name");

            if (selectedCourseName && selectedCourseName !== "Select Class" && selectedCourseName !== "") {
                allNames.forEach(item => {
                    if (item.Class === selectedCourseName && item.Name) {
                        namesForCurrentCourse.add(item.Name);
                    }
                });
            }
            
            uniqueNamesForCourse = Array.from(namesForCurrentCourse);

            setUpDropdown2('nameDropdown', uniqueNamesForCourse);
            setUpDropdown2('nameQueue', uniqueNamesForCourse);
            setUpDropdown2('lateNameDropdown', uniqueNamesForCourse); // Apply to late sign-in too
        };


       // For Bathroom Pass Class Change
        function courseChanged(){
            const selectedCourse = courseDropdown.value;

            if (selectedCourse !== "" && selectedCourse !== "Select Class") { // Check for actual class selection
                nameDropdown.removeAttribute("disabled");
                nameQueueDropdown.removeAttribute("disabled");
                lateNameDropdown.removeAttribute("disabled"); // Enable late name dropdown
                // emojiDropdown.removeAttribute("disabled"); // Emoji dropdown enabled/disabled by nameSelected

                setUpDropdown2('nameDropdown', [], "Loading..."); // Show loading state
                setUpDropdown2('nameQueue', [], "Loading..."); // Show loading state
                setUpDropdown2('lateNameDropdown', [], "Loading..."); // Show loading state

                populateNameDropdownsForCourse(selectedCourse); // Filter all dropdowns by selected class
            } else {
                // No class selected or "Select Class" is chosen
                setUpDropdown2('nameDropdown', [], "Select Your Name");
                nameDropdown.setAttribute("disabled", "disabled");

                setUpDropdown2('nameQueue', [], "Select Your Name");
                nameQueueDropdown.setAttribute("disabled", "disabled");

                setUpDropdown2('lateNameDropdown', [], "Select Your Name");
                lateNameDropdown.setAttribute("disabled", "disabled"); // Disable if no class selected

                setUpDropdown('emojiDropdown', emojiList, "No Emoji"); // Reset emoji dropdown
                emojiDropdown.classList.add('hidden'); // Ensure hidden
                emojiDropdown.setAttribute("disabled", "disabled"); // Disable emoji dropdown

                document.getElementById("signOutButton").style.display = "none";
            }
            updateToggleButtonVisibility();
        }

       // This function is now simplified, as filtering is done by populateNameDropdownsForCourse
        function updateNameDropdown() {
            document.getElementById("signOutButton").style.display = "none";
            document.getElementById("signInButton").style.display = "none";

            const selectedCourse = courseDropdown.value;
            if (selectedCourse) {
                // This call ensures dropdowns are populated if 'updateNameDropdown' is called directly
                // (e.g., after initial load, or if courseChanged was not triggered for some reason)
                populateNameDropdownsForCourse(selectedCourse); 
                nameDropdown.removeAttribute("disabled");
                nameQueueDropdown.removeAttribute("disabled");
                lateNameDropdown.removeAttribute("disabled");
                // emojiDropdown.removeAttribute("disabled"); // Emoji dropdown enabled/disabled by nameSelected
            } else {
                // If no course is selected, disable and reset name dropdowns
                setUpDropdown2('nameDropdown', [], "Select Your Name");
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Select Your Name");
                nameQueueDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('lateNameDropdown', [], "Select Your Name");
                lateNameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown('emojiDropdown', emojiList, "No Emoji"); // Reset emoji dropdown
                emojiDropdown.classList.add('hidden'); // Ensure hidden
                emojiDropdown.setAttribute("disabled", "disabled");
            }
            
            nameDropdown.value = 'Select Your Name';
            nameQueueDropdown.value = 'Select Your Name';
            lateNameDropdown.value = 'Select Your Name'; // Reset late name dropdown
            emojiDropdown.value = 'No Emoji'; // Reset emoji dropdown
            toggleAddToQueueButton();
        }


        function nameSelected(){
            if(nameDropdown.value === "Select Your Name" || timerInterval !== null || nameDropdown.value === currentlySignedOutStudent){
                document.getElementById("signOutButton").style.display = "none";
                emojiDropdown.classList.add('hidden'); // Hide emoji dropdown
                emojiDropdown.setAttribute("disabled", "disabled"); // Disable emoji dropdown
                emojiDropdown.value = "No Emoji"; // Reset emoji
                emojiLeft.textContent = ""; // Clear emojis
                emojiRight.textContent = ""; // Clear emojis
            } else {
                document.getElementById("signOutButton").style.display = "block";
                emojiDropdown.classList.remove('hidden'); // Show emoji dropdown
                emojiDropdown.removeAttribute("disabled"); // Enable emoji dropdown
            }
            document.getElementById("signInButton").style.display = timerInterval !== null ? "block" : "none";
            updateToggleButtonVisibility(); // Update button visibility
        }

        function lateNameSelected(){
            // The button should only be enabled if a valid name is selected.
            if (lateNameDropdown.value === 'Select Your Name' || lateNameDropdown.value.trim() === '') {
                document.getElementById("lateSignInSubmitBtn").classList.add("hidden");
            } else {
                document.getElementById("lateSignInSubmitBtn").classList.remove("hidden");
            }
        }

        function setUpDropdown(dropdownId, arr, defaultText = "Select Class") {
            let selectElement = document.getElementById(dropdownId);
            removeOptions(selectElement);
            selectElement.add(new Option(defaultText, ""));
            arr.forEach(str => {
                selectElement.add(new Option(str, str));
            });
        }

        function setUpDropdown2(dropdownId, arr, defaultText = "Select Your Name") {
            let selectElement = document.getElementById(dropdownId);
            removeOptions(selectElement);
            selectElement.add(new Option(defaultText, "Select Your Name"));
            arr.forEach(str => {
                if (str !== "Select Your Name") {
                    selectElement.add(new Option(str, str));
                }
            });
        }

        // Functions to toggle the right-side views and button styles
        function showQueueView() {
            queueArea.classList.remove('hidden');
            lateSignInView.classList.add('hidden');

            // Set Queue button to active style (purple)
            queueViewBtn.classList.add('bg-purple-400', 'text-white');
            queueViewBtn.classList.remove('bg-yellow-200', 'text-gray-800'); // Corrected inactive background

            // Set Late Sign In button to its inactive style (yellow)
            lateSignInViewBtn.classList.add('bg-yellow-200', 'text-gray-800');
            lateSignInViewBtn.classList.remove('bg-purple-400', 'text-white'); // Corrected inactive background
        }

        function showLateSignInView() {
            queueArea.classList.add('hidden');
            lateSignInView.classList.remove('hidden');

            // Set Late Sign In button to active style (yellow)
            lateSignInViewBtn.classList.add('bg-yellow-200', 'text-gray-800');
            lateSignInViewBtn.classList.remove('bg-purple-400', 'text-white'); // Corrected inactive background

            // Set Queue button to its inactive style (purple)
            queueViewBtn.classList.add('bg-purple-400', 'text-white');
            queueViewBtn.classList.remove('bg-yellow-200', 'text-gray-800'); // Corrected inactive background
        }

        // Function to control the visibility of the toggle buttons
        function updateToggleButtonVisibility() {
            // This function is now simplified as buttons are always visible in HTML.
            // Their visibility is controlled by the initial HTML structure.
            // The active/inactive state is handled by showQueueView/showLateSignInView.
        }

        // Event listeners for the new toggle buttons
        queueViewBtn.addEventListener('click', showQueueView);
        lateSignInViewBtn.addEventListener('click', showLateSignInView);

        // Event listeners for the new Google Profile/Dropdown
        const profilePicture = document.getElementById('profilePicture');
        const profileDropdown = document.getElementById('profileDropdown');
        const dropdownSignOutButton = document.getElementById('dropdownSignOutButton');
        const profileMenuContainer = document.getElementById('profileMenuContainer');

        profilePicture.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent document click from closing it immediately
            profileDropdown.classList.toggle('hidden');
        });

        dropdownSignOutButton.addEventListener('click', signOut);

        // Close dropdown when clicking outside
        document.body.addEventListener('click', (event) => {
            if (!profileMenuContainer.contains(event.target) && !profileDropdown.classList.contains('hidden')) {
                profileDropdown.classList.add('hidden');
            }
        });

        // Initialize Google Sign-In when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initGoogleSignIn);
    </script>
</body>
</html>
```

The persistent CORS error, even with "Anyone" access, when the URL includes `/a/macros/aspenk12.net/`, strongly suggests that the issue is with the **Google Workspace domain's configuration or a very early interception by Google's infrastructure** before your Apps Script's `doPost` function can even execute and set the `Access-Control-Allow-Origin` header.

Here's what you need to investigate further:

1.  **Apps Script Executions Log (Crucial!):**
    * Go to your Google Apps Script project.
    * In the left sidebar, click on **`Executions`** (it looks like a clock icon or a list icon).
    * **After you try to trigger the `fetch` from your frontend**, check this log immediately.
    * **Are there *any* new entries corresponding to your frontend requests?**
        * **If NO new entries:** This is the most telling sign. It means the request is being blocked by Google's infrastructure *before* it even reaches your script. This is likely due to domain-level policies.
        * **If there ARE new entries:**
            * Do they show "Completed" or "Failed"?
            * If "Failed," click on the failed execution to see the detailed error message and stack trace. This will tell us exactly where in your `doPost` function the script is failing.

2.  **Network Tab Inspection (Re-confirm):**
    * Open your browser's Developer Tools (F12) and go to the `Network` tab.
    * Clear the log.
    * Trigger the `fetch` request from your frontend (e.g., sign in, or trigger `fetchAllNames`).
    * Look for the `POST` request to your Apps Script URL (`https://script.google.com/a/macros/aspenk12.net/s/.../exec`).
    * Click on this request.
    * Go to the **`Headers`** tab.
    * **Under "Response Headers":** Confirm if `Access-Control-Allow-Origin` is present. If it's not, and there are no execution logs, it points to the blocking occurring before your script runs.
    * **What is the HTTP `Status` code of this `POST` request?** (e.g., `(failed)`, `400`, `500` - `(failed)` is common for CORS blocks).

**What to do if there are NO execution logs (most likely scenario):**

If your Apps Script execution logs show no activity from your frontend requests, the problem is almost certainly at the Google Workspace domain level. In this case, you will need to:

* **Contact your Google Workspace Administrator/IT Department:**
    * Explain that you are trying to deploy a Google Apps Script web app (provide them with the script ID and the web app URL).
    * Mention that your frontend is hosted on `https://jander15.github.io`.
    * Explain that you are encountering a CORS error (`No 'Access-Control-Allow-Origin' header is present`) and that the requests are not even appearing in your Apps Script's execution logs.
    * Ask them to check if there are any **domain-level security policies, firewall rules, or "Context-Aware Access" settings** in the Google Workspace Admin Console that might be blocking cross-origin requests to Apps Script web apps deployed within the `aspenk12.net` domain from external origins like `github.io`. They might need to whitelist `https://jander15.github.io` as an allowed origin for Apps Script web apps.

This is a specific challenge that arises when deploying Apps Scripts within managed Google Workspace domains, as these environments often have stricter default security configuratio