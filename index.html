<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="683459371071-7bm37ul6uatesp6g5nsf8lu1mnl9pnjm.apps.googleusercontent.com">
    <title>School Pass System by Jander</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
    >

    <script type="text/javascript">
    // This function prompts the user before leaving the page.
    window.onbeforeunload = function() {
        return "Are you sure you want to leave? Your pass status might be lost!";
    }
    </script>

    <style>
        /* Body font and background color */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1c1d1d; /* Dark background for the page */
        }
        /* Form text size and transition */
        form {
            font-size: 1.125rem; /* text-lg */
            transition: background-color 0.5s ease; /* Smooth transition for form color changes */
        }
        /* Select element text size */
        select {
            font-size: 1.125rem; /* text-lg for consistency with form text */
        }
        /* Remove default focus styles from select elements */
        select:focus {
            outline: none;
            border-color: #d1d5db; /* Revert to default border color on focus */
            box-shadow: none; /* Remove any box shadow on focus */
        }
        /* Styling for queue list items */
        #queue-list li {
            cursor: pointer;
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            margin-bottom: 0.375rem;
        }
        /* No bottom margin for the last item in the queue list */
        #queue-list li:last-child {
            margin-bottom: 0;
        }
        /* Hover effect for queue list items */
        #queue-list li:hover {
            background-color: #e2e8f0;
            color: #1a202c;
        }
        /* Specific class for selected item in the queue */
        #queue-list li.bg-yellow-200-selected {
            background-color: #0692e8; /* A distinct blue for selected item */
            color: #2d3748;
        }
        /* Hidden iframe for form submissions (Google Apps Script) */
        iframe[name="iframe"] {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 0;
            height: 0;
            visibility: hidden;
        }
        /* Style for the large header displaying pass status */
        #studentOutHeader {
             font-size: 5rem; /* Large text size */
             line-height: 1.1;
             color: #030000; /* Black text */
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 min-h-screen" id="body">

    <div id="googleSignInContainer" class="flex flex-col items-center justify-center min-h-screen w-full">
        <h2 class="text-3xl font-bold text-white mb-6 text-center">Please Sign In to Access the Pass System</h2>
        <div class="g-signin2" data-onsuccess="onSignIn" data-width="240" data-height="50" data-longtitle="true"></div>
    </div>

    <div id="appContent" class="hidden flex flex-col items-center w-full">
        <h1 id="studentOutHeader" class="font-bold text-center mb-6 p-2 w-full rounded-lg">
            <span id="studentOutName"></span> PASS IS AVAILABLE
        </h1>

        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative text-sm hidden mb-2 w-2/3" id="alertDiv" role="alert">
            <strong class="font-bold">Success!</strong>
            <span class="block sm:inline" id="alertMessage">You have been signed in successfully!</span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('alertDiv').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-green-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <div id="mainContentContainer" class="flex flex-col lg:flex-row items-start lg:items-stretch justify-center w-full max-w-6xl gap-6">

            <form
                id="form"
                class="rounded-lg shadow-xl p-6 w-full lg:w-2/3 space-y-4 flex-shrink-0"
                method="POST"
                target="iframe"
                style="background-color: #4ade80;" /* Initial background for the form (Green) */
            >
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Bathroom Pass</h2>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="class">Class:</label>
                    <select id="courseDropdown" onchange="courseChanged()" name="Class"
                        class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex flex-col sm:flex-row items-start sm:items-center">
                    <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="name">Name:</label>
                    <select id="nameDropdown" onchange="nameSelected()" class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                    </select>
                </div>

                <div class="flex justify-center space-x-3 mt-4">
                    <button id="signOutButton" type="button"
                        class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign Out
                    </button>
                    <button id="signInButton" type="submit"
                        class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none transition-colors duration-200 text-base"
                        style="display: none">
                        Sign In
                    </button>
                </div>

                <p class="text-center text-lg font-medium text-gray-800 mt-4">Time: <span id="minutes" class="font-bold">0</span>:<span id="seconds" class="font-bold">00</span></p>
                <textarea id="timeOut" name="Seconds" class="hidden"></textarea>
                <textarea id="nameHolder" name="Name" class="hidden"></textarea>
                <input type="hidden" id="teacherEmailInput" name="TeacherEmail">
            </form>

            <div id="rightSideFormsContainer" class="w-full lg:w-1/3 flex flex-col rounded-lg shadow-xl">
                <div class="flex w-full justify-center">
                    <button id="queueViewBtn" class="px-6 py-3 w-1/2 rounded-tl-lg rounded-tr-none font-semibold text-white bg-purple-400 hover:bg-purple-500 focus:outline-none transition-colors duration-200">
                        View Queue
                    </button>
                    <button id="lateSignInViewBtn" class="px-6 py-3 w-1/2 rounded-tl-none rounded-tr-lg font-semibold text-gray-800 bg-yellow-200 hover:bg-yellow-300 focus:outline-none transition-colors duration-200">
                        Late Sign In
                    </button>
                </div>

                <div id="queueArea" class="bg-purple-400 p-6 w-full text-center flex-shrink-0 rounded-b-lg flex-grow hidden">
                    <h2 class="text-2xl font-bold text-black-900 text-center mb-5">Queue for Bathroom</h2>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="nameQueue">Name:</label>
                        <select id="nameQueue"
                            class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">
                        </select>
                    </div>
                    <button id="add-to-queue"
                        class="mt-4 px-5 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none transition-colors duration-200 text-base hidden">
                        Add to Queue
                    </button>

                    <div id="message-area" class="bg-blue-50 border border-blue-200 rounded-md p-4 text-blue-800 mt-4">
                        <p id="message-text" class="hidden text-center text-base font-medium">Please select your name and click 'Add to Queue'.</p>
                        <ol id="queue-list" class="list-decimal list-inside mt-3 text-left text-gray-800 text-base">
                        </ol>
                        <button id="remove-from-queue"
                            class="mt-4 px-5 py-2.5 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none transition-colors duration-200 text-base hidden">
                            Remove Selected from Queue
                        </button>
                    </div>
                </div>

                <div id="lateSignInView" class="flex flex-col items-center justify-start w-full p-6 rounded-b-lg bg-yellow-200 flex-grow">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Late Sign In</h2>
                    <form id="lateSignInForm" class="w-full space-y-4" method="POST" target="iframe">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center">
                            <label class="font-medium text-gray-700 w-24 mb-1 sm:mb-0" for="lateNameDropdown">Name:</label>
                            <select id="lateNameDropdown"  onchange="lateNameSelected()"
                                class="block w-full p-2.5 border border-gray-300 rounded-md shadow-sm focus:outline-none">

                            </select>
                        </div>
                        <div class="flex justify-center mt-6">
                            <button type="submit" id="lateSignInSubmitBtn" class=" hidden px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none transition-colors duration-200 text-base">
                                Sign In Late
                            </button>
                        </div>
                        <textarea id="timeOut2" name="Seconds" class="hidden"></textarea>
                        <textarea id="nameHolder2" name="Late" class="hidden"></textarea>
                        <textarea id="classHolder" name="Class" class="hidden"></textarea>
                        <input type="hidden" id="teacherEmailInputLate" name="TeacherEmail">
                    </form>
                </div>
            </div>

        </div>

        <iframe name="iframe"></iframe>

        <a href="#" onclick="signOut();" class="mt-8 text-blue-400 hover:text-blue-600">Sign out of Google</a>
    </div>

    <script>
        // Global variables for the application
        const mainForm = document.getElementById('form');
        const nameDropdown = document.getElementById('nameDropdown');
        const courseDropdown = document.getElementById('courseDropdown');
        const nameQueueDropdown = document.getElementById('nameQueue');
        const studentOutHeader = document.getElementById('studentOutHeader');
        const studentOutName = document.getElementById('studentOutName');
        const teacherEmailInput = document.getElementById('teacherEmailInput'); // New input for main form
        const teacherEmailInputLate = document.getElementById('teacherEmailInputLate'); // New input for late form

        const queueArea = document.getElementById('queueArea');
        const lateSignInView = document.getElementById('lateSignInView');
        const queueViewBtn = document.getElementById('queueViewBtn');
        const lateSignInViewBtn = document.getElementById('lateSignInViewBtn');

        const lateNameDropdown = document.getElementById('lateNameDropdown');
        const lateSignInForm = document.getElementById('lateSignInForm');

        let seconds = 0;
        let minutes = 0;
        let timerInterval = null;
        let queue = [];
        let selectedName = null;
        let currentlySignedOutStudent = null;
        let allNamesData = [];
        let classes = [];
        let uniqueCourses = [];
        let uniqueNames = [];
        let allNames = [];
        let signedInUserEmail = null; // Will store the email of the signed-in user

        // Google Sign-In callback function
        function onSignIn(googleUser) {
            // Get user profile information
            var profile = googleUser.getBasicProfile();
            console.log('ID: ' + profile.getId());
            console.log('Name: ' + profile.getName());
            console.log('Image URL: ' + profile.getImageUrl());
            console.log('Email: ' + profile.getEmail());

            signedInUserEmail = profile.getEmail(); // Store the email globally

            // Set hidden input values for forms
            teacherEmailInput.value = signedInUserEmail;
            teacherEmailInputLate.value = signedInUserEmail;


            // Hide the Google Sign-In container
            document.getElementById('googleSignInContainer').classList.add('hidden');
            // Show the main application content
            document.getElementById('appContent').classList.remove('hidden');

            // Initialize the application data and UI after successful sign-in
            initializeAppDataAndUI();
        }

        // Function to sign out of Google
        function signOut() {
            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
                // Hide the main application content
                document.getElementById('appContent').classList.add('hidden');
                // Show the Google Sign-In container
                document.getElementById('googleSignInContainer').classList.remove('hidden');
                // Optionally, reset any app state here if needed
                resetAppState();
            });
        }

        // Function to reset application state on sign out
        function resetAppState() {
            clearInterval(timerInterval);
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            queue = [];
            selectedName = null;
            currentlySignedOutStudent = null;
            allNamesData = [];
            classes = [];
            uniqueCourses = [];
            uniqueNames = [];
            allNames = [];
            signedInUserEmail = null; // Clear email on sign out

            // Reset hidden input values
            teacherEmailInput.value = '';
            teacherEmailInputLate.value = '';


            // Reset UI elements
            document.getElementById("minutes").textContent = "0";
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signOutButton").style.display = "none";
            document.getElementById("signInButton").style.display = "none";
            courseDropdown.removeAttribute("disabled"); // Re-enable for next sign-in
            mainForm.style.backgroundColor = "#4ade80"; // Green
            studentOutHeader.textContent = "PASS IS AVAILABLE";
            studentOutHeader.style.backgroundColor = "#4ade80"; // Green
            studentOutName.textContent = '';
            nameDropdown.value = 'Select Your Name';
            nameDropdown.removeAttribute("disabled");
            nameQueueDropdown.setAttribute("disabled", "disabled");
            lateNameDropdown.setAttribute("disabled", "disabled");
            updateQueueDisplay();
            showLateSignInView();
            updateToggleButtonVisibility();
        }

        // This function will be called once the Google user is signed in
        function initializeAppDataAndUI() {
            const alertDiv = document.getElementById("alertDiv");
            if (alertDiv) {
                alertDiv.classList.add("hidden");
            }

            // Set initial state for studentOutHeader
            studentOutHeader.textContent = "PASS IS AVAILABLE";
            studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass

            // Set up initial dropdown states
            setUpDropdown('courseDropdown', [], "Loading...");
            courseDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameDropdown', [], "Select Your Name");
            nameDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('nameQueue', [], "Select Your Name");
            nameQueueDropdown.setAttribute("disabled", "disabled");

            setUpDropdown2('lateNameDropdown', [], "Select Your Name");
            lateNameDropdown.setAttribute("disabled", "disabled");

            document.getElementById("signOutButton").style.display = "none";

            // Fetch data and set up views
            fetchClassData();
            fetchAllNames();
            updateQueueDisplay(); // Initial display of queue (likely empty)
            showLateSignInView(); // Set initial right-side view to Late Sign In
            updateToggleButtonVisibility(); // Initial button visibility update
        }

        // Ensure the app content is hidden initially until sign-in
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('appContent').classList.add('hidden');
            document.getElementById('googleSignInContainer').classList.remove('hidden');
        });

        // Timer update function
        function updateTimer() {
            seconds++;
            const TARDY_TIME = 5; // Time in minutes after which the pass turns red
            document.getElementById("timeOut").value = (minutes * 60) + seconds;
            if (seconds >= 60) {
                minutes++;
                seconds = 0;
            }
            if (minutes >= TARDY_TIME) {
                mainForm.style.backgroundColor = "#ef4444"; // Red
                studentOutHeader.style.backgroundColor = "#ef4444";
            }
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = seconds < 10 ? "0" + seconds : seconds;
        }

        // Event listener for Bathroom Sign Out button
        document.getElementById("signOutButton").addEventListener("click", function() {
            if (!timerInterval) { // Prevent starting timer if already running
                timerInterval = setInterval(updateTimer, 1000); // Start timer
                this.style.display = "none"; // Hide Sign Out button
                document.getElementById("signInButton").style.display = "block"; // Show Sign In button
                nameDropdown.setAttribute("disabled", "disabled"); // Disable name dropdown
                courseDropdown.setAttribute("disabled", "disabled"); // Disable course dropdown
                mainForm.style.backgroundColor = "#f6b26b"; // Orange for "signed out" state

                const fullString = nameDropdown.value;
                // Extract name without the number in parentheses
                const nameOnly = fullString.includes("(") ? fullString.substring(0, fullString.indexOf("(")-1) : fullString;
                document.getElementById("nameHolder").value = nameOnly; // Store name for form submission

                studentOutHeader.textContent = `${nameOnly} IS OUT`; // Update header text
                studentOutHeader.style.backgroundColor = "#f6b26b"; // Orange for "IS OUT"

                currentlySignedOutStudent = fullString; // Keep track of who is signed out
                updateQueueDisplay(); // Refresh queue display
                showQueueView(); // Automatically switch to queue view
                updateToggleButtonVisibility(); // Update button visibility

                // Set up queue dropdown and enable it
                setUpDropdown2('nameQueue', uniqueNames);
                nameQueueDropdown.value = 'Select Your Name';
                nameQueueDropdown.removeAttribute('disabled');
                toggleAddToQueueButton();
            }
        });

        // Event listener for Bathroom Sign In form submission
        mainForm.addEventListener("submit", function() {
            clearInterval(timerInterval); // Stop the timer
            timerInterval = null;
            seconds = 0;
            minutes = 0;
            document.getElementById("minutes").textContent = minutes;
            document.getElementById("seconds").textContent = "00";
            document.getElementById("signInButton").style.display = "none";
            document.getElementById("signOutButton").style.display = "none";
            courseDropdown.removeAttribute("disabled"); // Re-enable course dropdown
            mainForm.style.backgroundColor = "#4ade80"; // Green for "available" state

            // Show success alert
            document.getElementById("alertDiv").classList.remove("hidden");
            document.getElementById("alertMessage").textContent = `${currentlySignedOutStudent} has been signed in successfully!`;
            setTimeout(() => document.getElementById("alertDiv").classList.add("hidden"), 5000);

            currentlySignedOutStudent = null; // Clear currently signed out student

            if (queue.length > 0) {
                const nextPerson = queue.shift(); // Get the next person from the queue
                nameDropdown.value = nextPerson; // Set their name in the main dropdown
                nameDropdown.setAttribute("disabled", "disabled"); // Disable main name dropdown
                updateMessage(`${nextPerson} can now sign out.`);
                updateQueueDisplay(); // Refresh queue display
                nameSelected(); // Trigger name selection logic

                studentOutName.textContent = nextPerson;
                studentOutHeader.textContent = `${nextPerson} IS NEXT`; // Update header
                studentOutHeader.style.backgroundColor = "#4ade80"; // Green for "IS NEXT"

                showQueueView(); // Keep queue view active
            } else {
                nameDropdown.value = 'Select Your Name'; // Reset main name dropdown
                nameDropdown.removeAttribute("disabled"); // Enable main name dropdown
                document.getElementById("signOutButton").style.display = "none";
                updateMessage('The queue is empty. No one is currently signed out.');
                studentOutHeader.textContent = "PASS IS AVAILABLE"; // Update header
                studentOutHeader.style.backgroundColor = "#4ade80"; // Green for available pass
                studentOutName.textContent = '';
                nameQueueDropdown.setAttribute("disabled", "disabled"); // Disable queue dropdown

                showLateSignInView(); // Switch back to late sign-in view if queue is empty
            }
            toggleAddToQueueButton(); // Update add to queue button visibility
            updateToggleButtonVisibility(); // Update toggle button visibility
        });

        // Event listener for Late Sign In form submission
        lateSignInForm.addEventListener('submit', function(event) {
            const selectedLateName = lateNameDropdown.value;

            // Prevent submission if "Select Your Name" is still chosen
            if (selectedLateName === 'Select Your Name' || selectedLateName.trim() === '') {
                event.preventDefault(); // Stop the form from submitting
                // Display an error message to the user
                document.getElementById("alertDiv").classList.remove("hidden");
                document.getElementById("alertDiv").classList.add("bg-red-100", "border-red-400", "text-red-700");
                document.getElementById("alertDiv").classList.remove("bg-green-100", "border-green-400", "text-green-700");
                document.getElementById("alertMessage").textContent = `Please select a valid name to sign in late.`;
                setTimeout(() => {
                    document.getElementById("alertDiv").classList.add("hidden");
                    // Reset to green after alert
                    document.getElementById("alertDiv").classList.remove("bg-red-100", "border-red-400", "text-red-700");
                    document.getElementById("alertDiv").classList.add("bg-green-100", "border-green-400", "text-green-700");
                }, 5000);
            } else {
                const nameOnly2 = selectedLateName.includes("(") ? selectedLateName.substring(0, selectedLateName.indexOf("(")-1) : selectedLateName;
                document.getElementById("nameHolder2").value = nameOnly2; // Store name for form submission

                document.getElementById("alertDiv").classList.remove("hidden");
                document.getElementById("alertMessage").textContent = `${selectedLateName} has been signed in late successfully!`;
                setTimeout(() => document.getElementById("alertDiv").classList.add("hidden"), 5000);

                // Reset the dropdown after a short delay to allow submission
                setTimeout(() => {
                    lateNameDropdown.value = 'Select Your Name';
                    document.getElementById("lateSignInSubmitBtn").classList.add("hidden")
                }, 100);
            }
        });

        // Helper function to extract number from name (e.g., "John Doe (123)")
        function getNumberFromName(name) {
            const match = name.match(/\((\d+)\)$/);
            return match ? parseInt(match[1]) : Infinity;
        }

        // Function to update the message area in the queue section
        function updateMessage(message) {
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-text').classList.remove('hidden'); // Ensure message is visible
        }

        // Function to update the display of the queue list
        function updateQueueDisplay() {
            const queueList = document.getElementById('queue-list');
            const removeFromQueueButton = document.getElementById('remove-from-queue');

            queueList.innerHTML = ''; // Clear existing list items
            selectedName = null; // Reset selected name
            removeFromQueueButton.classList.add('hidden'); // Hide remove button

            if (queue.length === 0) {
                queueList.style.display = 'none'; // Hide the ordered list
                if (!currentlySignedOutStudent) {
                   updateMessage('The queue is currently empty. Add your name!');
                } else {
                   updateMessage('No one else is in queue. Select your name below to add.');
                }
            } else {
                queueList.style.display = 'block'; // Show the ordered list
                updateMessage('Please select a name from the list to remove, or add another.');

                // Sort the queue by the number in parentheses (if present)
                queue.sort((a, b) => getNumberFromName(a) - getNumberFromName(b));

                // Populate the queue list
                queue.forEach((person) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${person}`;
                    listItem.addEventListener('click', () => {
                        // Remove selection from other items
                        Array.from(queueList.children).forEach(item => {
                            item.classList.remove('bg-yellow-200-selected');
                        });
                        selectedName = person; // Set selected name
                        listItem.classList.add('bg-yellow-200-selected'); // Highlight selected item
                        removeFromQueueButton.classList.remove('hidden'); // Show remove button
                    });
                    queueList.appendChild(listItem);
                });
            }
            toggleAddToQueueButton(); // Update add to queue button visibility
            updateToggleButtonVisibility(); // Update toggle button visibility
        }

        // Function to control the visibility of the "Add to Queue" button
        function toggleAddToQueueButton() {
            const addToQueueButton = document.getElementById('add-to-queue');
            if (nameQueueDropdown.value === 'Select Your Name' || nameQueueDropdown.value.trim() === '') {
                addToQueueButton.classList.add('hidden');
            } else {
                addToQueueButton.classList.remove('hidden');
            }
        }

        // Event listener for queue name dropdown change
        nameQueueDropdown.addEventListener('change', toggleAddToQueueButton);

        // Event listener for "Add to Queue" button
        document.getElementById('add-to-queue').addEventListener('click', () => {
            const name = nameQueueDropdown.value.trim();

            if (name === 'Select Your Name' || name === '') {
                updateMessage('Please select your name to add to the queue.');
            } else if (queue.includes(name)) {
                updateMessage('You are already in the queue.');
            } else if (currentlySignedOutStudent && name === currentlySignedOutStudent) {
                updateMessage(`${name} is currently signed out and cannot be added to the queue.`);
            } else {
                queue.push(name); // Add name to queue
                updateMessage(`${name} has been added to the queue.`);
                updateQueueDisplay(); // Refresh queue display
                nameQueueDropdown.value = 'Select Your Name'; // Reset queue name dropdown
                toggleAddToQueueButton(); // Update add to queue button visibility
                // Ensure queue is visible if something is added and no one is out
                if (!currentlySignedOutStudent) {
                    showQueueView();
                }
            }
            updateToggleButtonVisibility(); // Update toggle button visibility
        });

        // Event listener for "Remove Selected from Queue" button
        document.getElementById('remove-from-queue').addEventListener('click', () => {
            if (queue.length === 0) {
                updateMessage('The queue is already empty.');
            } else if (!selectedName) {
                updateMessage('Please select a name from the list to remove.');
            } else {
                const index = queue.indexOf(selectedName);
                if (index > -1) {
                    queue.splice(index, 1); // Remove selected name from queue
                    updateMessage(`Removed ${selectedName} from the queue.`);
                    updateQueueDisplay(); // Refresh queue display
                } else {
                    updateMessage('Error: Name not found in queue.');
                }
                if (queue.length === 0 && !currentlySignedOutStudent) {
                    showLateSignInView(); // Go back to late sign-in if queue is empty and no one is out
                }
            }
            updateToggleButtonVisibility(); // Update toggle button visibility
        });

        // URL for Google Apps Script deployment
        const url = "https://script.google.com/macros/s/AKfycbzIalB21jM1-vuBfJTpRjtwMc1jJYe0XL5SqCozJCzyNrpd6SBF0Mh_RXITRY5yC-Po/exec";
        document.getElementById('form').action = url;
        document.getElementById('lateSignInForm').action = url;

        // Function to fetch class data from Google Apps Script
        function fetchClassData() {
            if (!signedInUserEmail) {
                console.error("User email not available for fetching class data. Please sign in.");
                setUpDropdown('courseDropdown', [], "Sign in to load classes");
                courseDropdown.setAttribute("disabled", "disabled");
                return;
            }
            fetch(`${url}?header=Class&userEmail=${encodeURIComponent(signedInUserEmail)}`)
                .then((response) => response.json())
                .then(({ data }) => {
                    classes = data; // Store the original classes array
                    populateDatalists("classes", data); // Populate class dropdown
                    courseDropdown.removeAttribute("disabled"); // Enable class dropdown
                    courseDropdown.value = ""; // Set default value
                })
                .catch((error) => {
                    console.error('Error fetching class data:', error);
                    setUpDropdown('courseDropdown', [], "Error loading classes");
                });
        }

       // Function to fetch ALL names and classes to filter locally
        function fetchAllNames() {
            if (!signedInUserEmail) {
                console.error("User email not available for fetching all names. Please sign in.");
                setUpDropdown2('lateNameDropdown', [], "Sign in to load names");
                lateNameDropdown.setAttribute("disabled", "disabled");
                return;
            }
            // Assumes your Apps Script can handle this action and will filter by userEmail
            fetch(`${url}?action=getAllData&userEmail=${encodeURIComponent(signedInUserEmail)}`)
                .then(response => response.json())
                .then(data => {
                    // Ensure data is an array before processing
                    if (Array.isArray(data)) {
                        allNames = data; // e.g., [{Name: "Alice"}, {Name: "Bob"}] after filtering
                        const allUniqueNames = new Set();
                        allUniqueNames.add("Select Your Name");
                        data.forEach(item => {
                            if (item && item.Name) { // Assuming 'item' is an object with a 'Name' property after filtering
                                allUniqueNames.add(item.Name);
                            }
                        });
                        uniqueNames = Array.from(allUniqueNames); // Update uniqueNames for all relevant dropdowns
                        setUpDropdown2('lateNameDropdown', uniqueNames); // Populate late name dropdown
                    } else {
                        console.error('Error: fetchAllNames received non-array data after filtering:', data);
                        allNames = []; // Reset to empty array to prevent further errors
                        setUpDropdown2('lateNameDropdown', [], "Select Your Name");
                        document.getElementById('lateNameDropdown').setAttribute("disabled", "disabled");
                    }
                })
                .catch(error => console.error('Error fetching all names:', error));
        }

        // Populates the class dropdown
        const populateDatalists = (id, arr) => {
            const uniqueItems = new Set();
            for (const item of arr) {
                uniqueItems.add(item);
            }
            uniqueCourses = Array.from(uniqueItems);
            setUpDropdown('courseDropdown', uniqueCourses);
        };

        // Populates Bathroom Pass and Queue Names dropdowns based on selected course
        const populateDatalists2 = (arr, courseName) => {
            const uniqueItems = new Set();
            uniqueItems.add("Select Your Name");
            // Filter names based on the selected course
            for (let i = 0; i < classes.length; i++) {
                // Ensure 'allNames' data is available and has 'Class' and 'Name' properties for matching
                // This logic might need refinement based on your actual data structure from Apps Script
                if (allNames[i] && allNames[i].Class === courseName && allNames[i].Name) {
                    uniqueItems.add(allNames[i].Name);
                }
            }
            uniqueNames = Array.from(uniqueItems); // Specific to Bathroom Pass
            setUpDropdown2('nameDropdown', uniqueNames);
            setUpDropdown2('nameQueue', uniqueNames);
            // The lateNameDropdown is populated by fetchAllNames(), so we don't reset it here
            // setUpDropdown2('lateNameDropdown', uniqueNames); // Also update late sign-in name dropdown
        };


        // Helper function to remove all options from a select element
        function removeOptions(selectElement) {
            while (selectElement.options.length > 0) {
                selectElement.remove(0);
            }
        }

       // Event handler for when the course dropdown changes
        function courseChanged(){
            if (courseDropdown.value !== "") {
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameDropdown', [], "Loading...");
                nameQueueDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Loading...");
                lateNameDropdown.removeAttribute("disabled"); // Enable late name dropdown
                setUpDropdown2('lateNameDropdown', [], "Loading..."); // Still show loading while names update
                updateNameDropdown(); // Fetch and update names based on the new course
            } else {
                setUpDropdown2('nameDropdown', [], "Select Your Name");
                nameDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('nameQueue', [], "Select Your Name");
                nameQueueDropdown.setAttribute("disabled", "disabled");
                setUpDropdown2('lateNameDropdown', [], "Select Your Name"); // Reset late name dropdown
                lateNameDropdown.setAttribute("disabled", "disabled"); // Ensure it's disabled
                document.getElementById("signOutButton").style.display = "none";
            }
            updateToggleButtonVisibility(); // Update button visibility
        }

       // Fetches and updates Bathroom Pass names based on selected course
        function updateNameDropdown() {
            document.getElementById("signOutButton").style.display = "none";
            document.getElementById("signInButton").style.display = "none";

            if (!signedInUserEmail) {
                console.error("User email not available for updating name dropdown. Please sign in.");
                setUpDropdown2('nameDropdown', [], "Sign in to load names");
                setUpDropdown2('nameQueue', [], "Sign in to load names");
                setUpDropdown2('lateNameDropdown', [], "Sign in to load names");
                return;
            }

            fetch(`${url}?header=Name&userEmail=${encodeURIComponent(signedInUserEmail)}`)
                .then((response) => response.json())
                .then(({ data }) => {
                    populateDatalists2(data, courseDropdown.value);
                    nameDropdown.removeAttribute("disabled");
                    lateNameDropdown.removeAttribute("disabled");
                    nameDropdown.value = 'Select Your Name';
                    nameQueueDropdown.value = 'Select Your Name';
                    lateNameDropdown.value = 'Select Your Name'; // Reset late name dropdown
                    toggleAddToQueueButton();
                })
                .catch((error) => {
                    console.error('Error fetching name data:', error);
                    setUpDropdown2('nameDropdown', [], "Error loading names");
                    setUpDropdown2('nameQueue', [], "Error loading names");
                    setUpDropdown2('lateNameDropdown', [], "Error loading names");
                });
        }

        // Event handler for when a name is selected in the main bathroom pass dropdown
        function nameSelected(){
            // Show sign out button only if a valid name is selected and no one is currently signed out
            if(nameDropdown.value === "Select Your Name" || timerInterval !== null || nameDropdown.value === currentlySignedOutStudent){
                document.getElementById("signOutButton").style.display = "none";
            } else {
                document.getElementById("signOutButton").style.display = "block";
            }
            // Show sign in button only if someone is currently signed out
            document.getElementById("signInButton").style.display = timerInterval !== null ? "block" : "none";
            updateToggleButtonVisibility(); // Update button visibility
        }

        // Event handler for when a name is selected in the late sign-in dropdown
        function lateNameSelected(){
            // Show the "Sign In Late" button
            document.getElementById("lateSignInSubmitBtn").classList.remove("hidden");
            // Set the class holder value for the late sign-in form submission
            document.getElementById("classHolder").value = courseDropdown.value;
        }

        // Generic function to set up a dropdown with options
        function setUpDropdown(dropdownId, arr, defaultText = "Select Class") {
            let selectElement = document.getElementById(dropdownId);
            removeOptions(selectElement); // Clear existing options
            selectElement.add(new Option(defaultText, "")); // Add default option
            arr.forEach(str => {
                selectElement.add(new Option(str, str)); // Add other options
            });
            // Disable dropdown if loading or no options are available
            selectElement.disabled = (arr.length === 0 && defaultText.includes("Loading..."));
        }

        // Generic function to set up a dropdown with options, specifically for names
        function setUpDropdown2(dropdownId, arr, defaultText = "Select Your Name") {
            let selectElement = document.getElementById(dropdownId);
            removeOptions(selectElement); // Clear existing options
            selectElement.add(new Option(defaultText, "Select Your Name")); // Add default option
            arr.forEach(str => {
                if (str !== "Select Your Name") { // Avoid adding "Select Your Name" twice
                    selectElement.add(new Option(str, str)); // Add other options
                }
            });
            // The disabling logic is handled by specific functions like courseChanged or initializeAppDataAndUI
        }

        // Functions to toggle the right-side views and button styles
        function showQueueView() {
            queueArea.classList.remove('hidden');
            lateSignInView.classList.add('hidden');

            // Set Queue button to active style (purple)
            queueViewBtn.classList.add('bg-purple-400', 'text-white');
            queueViewBtn.classList.remove('bg-yellow-200', 'text-gray-800');

            // Set Late Sign In button to its inactive style (yellow)
            lateSignInViewBtn.classList.add('bg-yellow-200', 'text-gray-800');
            lateSignInViewBtn.classList.remove('bg-purple-400', 'text-white');
        }

        function showLateSignInView() {
            queueArea.classList.add('hidden');
            lateSignInView.classList.remove('hidden');

            // Set Late Sign In button to active style (yellow)
            lateSignInViewBtn.classList.add('bg-yellow-200', 'text-gray-800');
            lateSignInViewBtn.classList.remove('bg-purple-400', 'text-white');

            // Set Queue button to its inactive style (purple)
            queueViewBtn.classList.add('bg-purple-400', 'text-white');
            queueViewBtn.classList.remove('bg-yellow-200', 'text-gray-800');
        }

        // Function to control the visibility of the toggle buttons (now primarily styling)
        function updateToggleButtonVisibility() {
            // This function primarily handles the active/inactive styling of the toggle buttons.
            // Their visibility is controlled by the initial HTML structure and the `appContent` div.
        }

        // Event listeners for the new toggle buttons
        queueViewBtn.addEventListener('click', showQueueView);
        lateSignInViewBtn.addEventListener('click', showLateSignInView);
    </script>
</body>
</html>
